<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Drama TOPIK Quiz</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #222;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* ── Header ── */
    header {
      background: #1a1a2e;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-back {
      position: absolute;
      left: 12px;
      color: #fff;
      text-decoration: none;
      font-size: 1.2rem;
      padding: 4px 8px;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1px;
    }

    .logo .play { color: #e94560; }

    /* ── Container ── */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px;
    }

    /* ── Start Screen ── */
    .start-screen {
      text-align: center;
      padding: 40px 16px;
    }

    .start-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .start-title {
      font-size: 1.4rem;
      font-weight: 900;
      color: #1a1a2e;
      margin-bottom: 8px;
    }

    .start-sub {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 28px;
      line-height: 1.6;
    }

    .section-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: #fff;
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .section-card:active {
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .section-card-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .section-card-body {
      flex: 1;
      text-align: left;
    }

    .section-card-title {
      font-size: 1rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 2px;
    }

    .section-card-desc {
      font-size: 0.78rem;
      color: #999;
    }

    .section-card-arrow {
      font-size: 1.2rem;
      color: #ccc;
      flex-shrink: 0;
    }

    .btn-all {
      margin-top: 16px;
      width: 100%;
      background: #1a1a2e;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-all:active { opacity: 0.8; }

    /* ── Progress Bar ── */
    .progress-wrap {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }

    .progress-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-section {
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      background: #1a1a2e;
      padding: 3px 10px;
      border-radius: 20px;
    }

    .progress-section.reading { background: #2196f3; }
    .progress-section.listening { background: #4caf50; }

    .progress-num {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
    }

    .progress-bar {
      height: 6px;
      background: #eee;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-fill.reading { background: #2196f3; }
    .progress-fill.listening { background: #4caf50; }

    /* ── Question Card ── */
    .q-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      overflow: hidden;
      margin-bottom: 12px;
    }

    .q-type-bar {
      padding: 10px 16px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      background: #607d8b;
    }

    .q-instruction {
      padding: 16px 16px 12px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #333;
      line-height: 1.6;
    }

    /* ── Image area ── */
    .q-image-wrap {
      padding: 0 16px 12px;
    }

    .q-image {
      width: 100%;
      max-height: 220px;
      object-fit: contain;
      border-radius: 10px;
      background: #f5f5f5;
      display: block;
    }

    .q-image-placeholder {
      width: 100%;
      height: 160px;
      background: #f0f2f5;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #bbb;
      flex-direction: column;
      gap: 6px;
    }

    .q-image-placeholder-icon {
      font-size: 2rem;
    }

    /* ── Image choices (L12 type) ── */
    .q-image-choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 0 16px 12px;
    }

    .q-img-choice {
      position: relative;
      background: #f5f5f5;
      border-radius: 10px;
      border: 3px solid transparent;
      cursor: pointer;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .q-img-choice.selected { border-color: #2196f3; }
    .q-img-choice.correct { border-color: #4caf50; }
    .q-img-choice.wrong { border-color: #e94560; }

    .q-img-choice img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      display: block;
    }

    .q-img-choice-placeholder {
      width: 100%;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #ccc;
    }

    .q-img-choice-label {
      text-align: center;
      padding: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #555;
    }

    .q-img-choice-num {
      position: absolute;
      top: 6px;
      left: 6px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── Audio area ── */
    .q-audio-wrap {
      padding: 0 16px 12px;
    }

    .q-audio-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      background: #f0f2f5;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 700;
      color: #555;
      transition: background 0.2s, border-color 0.2s;
    }

    .q-audio-btn.playing {
      background: #e8f5e9;
      border-color: #4caf50;
      color: #2e7d32;
    }

    .q-audio-btn:active {
      opacity: 0.8;
    }

    .q-audio-icon {
      font-size: 1.5rem;
    }

    .q-audio-label {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .q-audio-hint {
      font-size: 0.7rem;
      font-weight: 400;
      color: #aaa;
    }

    /* ── Passage ── */
    .q-passage {
      margin: 0 16px 12px;
      background: #f8f9fb;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 0.88rem;
      line-height: 1.8;
      color: #333;
      border-left: 4px solid #2196f3;
    }

    /* ── Question text (for fill-blank) ── */
    .q-question {
      padding: 0 16px 14px;
      font-size: 0.92rem;
      line-height: 1.8;
      color: #333;
      white-space: pre-line;
    }

    /* ── Choices ── */
    .q-choices {
      padding: 0 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .q-choice {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #f8f9fb;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 14px 14px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      font-family: inherit;
      text-align: left;
      width: 100%;
    }

    .q-choice:active:not(.answered) {
      background: #e8f0ff;
    }

    .q-choice-num {
      flex-shrink: 0;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: #666;
      transition: background 0.2s, color 0.2s;
    }

    .q-choice-text {
      flex: 1;
      font-size: 0.88rem;
      line-height: 1.5;
      color: #333;
      word-break: keep-all;
    }

    .q-choice-icon {
      flex-shrink: 0;
      font-size: 1.1rem;
      display: none;
    }

    /* States */
    .q-choice.selected {
      border-color: #2196f3;
      background: #e3f2fd;
    }

    .q-choice.selected .q-choice-num {
      background: #2196f3;
      color: #fff;
    }

    .q-choice.correct {
      border-color: #4caf50;
      background: #e8f5e9;
    }

    .q-choice.correct .q-choice-num {
      background: #4caf50;
      color: #fff;
    }

    .q-choice.correct .q-choice-icon {
      display: block;
    }

    .q-choice.wrong {
      border-color: #e94560;
      background: #fce4ec;
    }

    .q-choice.wrong .q-choice-num {
      background: #e94560;
      color: #fff;
    }

    .q-choice.wrong .q-choice-icon {
      display: block;
    }

    .q-choice.answered {
      cursor: default;
    }

    .q-choice.dimmed {
      opacity: 0.5;
    }

    /* ── Explanation ── */
    .q-explain {
      display: none;
      margin: 0 16px 16px;
      border-radius: 10px;
      overflow: hidden;
    }

    .q-explain.show {
      display: block;
    }

    .q-explain-ko {
      background: #e3f2fd;
      padding: 12px 14px;
      font-size: 0.82rem;
      line-height: 1.6;
      color: #1565c0;
    }

    .q-explain-ne {
      background: #e8f5e9;
      padding: 12px 14px;
      font-size: 0.82rem;
      line-height: 1.6;
      color: #2e7d32;
    }

    .q-explain-label {
      font-weight: 700;
      margin-right: 4px;
    }

    /* ── Audio transcript (after answering listening) ── */
    .q-transcript {
      display: none;
      margin: 0 16px 12px;
      background: #f3e5f5;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 0.82rem;
      line-height: 1.8;
      color: #6a1b9a;
      white-space: pre-line;
      border-left: 4px solid #ab47bc;
    }

    .q-transcript.show { display: block; }

    .q-transcript-label {
      font-weight: 700;
      display: block;
      margin-bottom: 4px;
    }

    /* ── Navigation ── */
    .q-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .q-nav-btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 0.92rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: opacity 0.2s;
    }

    .q-nav-btn:active { opacity: 0.8; }
    .q-nav-btn:disabled { opacity: 0.4; cursor: default; }

    .btn-prev {
      background: #eee;
      color: #555;
    }

    .btn-next {
      background: #1a1a2e;
      color: #fff;
    }

    .btn-next.ready {
      background: #4caf50;
    }

    /* ── Results Screen ── */
    .results {
      text-align: center;
      padding: 20px 0;
    }

    .results-circle-wrap {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 20px;
    }

    .results-circle {
      transform: rotate(-90deg);
    }

    .results-circle-bg {
      fill: none;
      stroke: #eee;
      stroke-width: 10;
    }

    .results-circle-fg {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s ease;
    }

    .results-score {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .results-score-num {
      font-size: 2.2rem;
      font-weight: 900;
      color: #222;
    }

    .results-score-total {
      font-size: 0.8rem;
      color: #999;
    }

    .results-grade {
      font-size: 1.5rem;
      font-weight: 900;
      margin-bottom: 4px;
    }

    .results-msg {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    /* ── Results Breakdown ── */
    .results-breakdown {
      text-align: left;
      margin-bottom: 20px;
    }

    .results-breakdown-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
      margin-bottom: 10px;
      padding: 0 4px;
    }

    .results-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #fff;
      border-radius: 10px;
      margin-bottom: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }

    .results-item-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .results-item-id {
      font-size: 0.75rem;
      font-weight: 700;
      color: #999;
      flex-shrink: 0;
      width: 32px;
    }

    .results-item-text {
      flex: 1;
      font-size: 0.82rem;
      color: #333;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .results-btns {
      display: flex;
      gap: 10px;
    }

    .results-btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 0.92rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .results-btn:active { opacity: 0.8; }

    .btn-retry {
      background: #1a1a2e;
      color: #fff;
    }

    .btn-home {
      background: #eee;
      color: #555;
    }

    /* ── Responsive ── */
    @media (min-width: 480px) {
      .container { padding: 16px; }
    }

    @media (min-width: 640px) {
      header { padding: 14px 20px; }
      .logo { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="header-back">&#8592;</a>
  <div class="logo">K<span class="play">&#9654;</span>Drama <span style="color:#ffc107">Quiz</span></div>
</header>

<div class="container">
  <!-- Start Screen -->
  <div id="start-screen" class="start-screen">
    <div class="start-icon">&#128221;</div>
    <div class="start-title">TOPIK 모의 퀴즈</div>
    <div class="start-sub">에피소드 1 자막에서 나온 단어와 문법으로<br>TOPIK 실전 문제를 풀어보세요!</div>
    <div class="section-cards">
      <div class="section-card" onclick="startQuiz('reading')">
        <div class="section-card-icon">&#128214;</div>
        <div class="section-card-body">
          <div class="section-card-title">읽기 (읽기)</div>
          <div class="section-card-desc" id="reading-count"></div>
        </div>
        <div class="section-card-arrow">&#8250;</div>
      </div>
      <div class="section-card" onclick="startQuiz('listening')">
        <div class="section-card-icon">&#127911;</div>
        <div class="section-card-body">
          <div class="section-card-title">듣기 (듣기)</div>
          <div class="section-card-desc" id="listening-count"></div>
        </div>
        <div class="section-card-arrow">&#8250;</div>
      </div>
      <button class="btn-all" onclick="startQuiz('all')">&#128170; 전체 풀기 (읽기 + 듣기)</button>
    </div>
  </div>

  <!-- Quiz Screen -->
  <div id="quiz-screen" style="display:none">
    <div class="progress-wrap">
      <div class="progress-top">
        <span class="progress-section" id="progress-section"></span>
        <span class="progress-num" id="progress-num"></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <div class="q-card" id="q-card"></div>

    <div class="q-nav">
      <button class="q-nav-btn btn-prev" id="btn-prev" onclick="prevQ()">&#8592; 이전</button>
      <button class="q-nav-btn btn-next" id="btn-next" onclick="nextQ()">다음 &#8594;</button>
    </div>
  </div>

  <!-- Results Screen -->
  <div id="results-screen" style="display:none"></div>
</div>

<script>
var quizData = null;
var questions = [];
var currentIdx = 0;
var answers = {}; // qId -> chosen index
var quizMode = 'all';
var quizAudio = null;

fetch('../data/quiz.json').then(function(r) { return r.json(); }).then(function(data) {
  quizData = data['1'];
  document.getElementById('reading-count').textContent = quizData.reading.length + '문제';
  document.getElementById('listening-count').textContent = quizData.listening.length + '문제';
});

function startQuiz(mode) {
  quizMode = mode;
  questions = [];
  answers = {};
  currentIdx = 0;

  if (mode === 'reading') {
    questions = quizData.reading.slice();
  } else if (mode === 'listening') {
    questions = quizData.listening.slice();
  } else {
    questions = quizData.reading.concat(quizData.listening);
  }

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('quiz-screen').style.display = 'block';
  document.getElementById('results-screen').style.display = 'none';
  renderQuestion();
}

function getSection(q) {
  for (var i = 0; i < quizData.reading.length; i++) {
    if (quizData.reading[i].id === q.id) return 'reading';
  }
  return 'listening';
}

function typeLabel(type) {
  var map = {
    '그림보고_단어고르기': '그림 보고 단어 고르기',
    '그림보고_문장고르기': '그림 보고 문장 고르기',
    '빈칸에_알맞은것': '빈칸에 알맞은 것 고르기',
    '설명에_맞는_어휘': '설명에 맞는 어휘 고르기',
    '글읽고_내용이해': '글 읽고 내용 이해',
    '들은것_고르기': '들은 것 고르기',
    '그림보고_대답고르기': '그림 보고 대답 고르기',
    '이어지는말_고르기': '이어지는 말 고르기',
    '내용과_관계있는_그림': '내용과 관계있는 그림 고르기',
    '이야기듣고_질문대답': '이야기 듣고 질문에 대답'
  };
  return map[type] || type;
}

function escH(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function renderQuestion() {
  stopAudio();
  var q = questions[currentIdx];
  var sec = getSection(q);
  var answered = answers[q.id] !== undefined;
  var total = questions.length;

  // Progress
  var pSec = document.getElementById('progress-section');
  pSec.textContent = sec === 'reading' ? '읽기' : '듣기';
  pSec.className = 'progress-section ' + sec;
  document.getElementById('progress-num').textContent = (currentIdx + 1) + ' / ' + total;

  var fill = document.getElementById('progress-fill');
  fill.style.width = ((currentIdx + 1) / total * 100) + '%';
  fill.className = 'progress-fill ' + sec;

  // Build card HTML
  var html = '';
  html += '<div class="q-type-bar">' + escH(typeLabel(q.type)) + '</div>';
  html += '<div class="q-instruction">' + escH(q.instruction) + '</div>';

  // Audio button (listening questions)
  if (q.audio) {
    html += '<div class="q-audio-wrap">';
    html += '<button class="q-audio-btn" id="audio-btn" onclick="toggleAudio()">';
    html += '<span class="q-audio-icon">&#128266;</span>';
    html += '<span class="q-audio-label"><span>음성 듣기</span><span class="q-audio-hint">버튼을 눌러 들으세요</span></span>';
    html += '</button>';
    html += '</div>';
  }

  // Image
  if (q.image && !q.image_choices) {
    html += '<div class="q-image-wrap">';
    html += '<img class="q-image" src="../' + escH(q.image) + '" alt="문제 이미지" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'">';
    html += '<div class="q-image-placeholder" style="display:none"><span class="q-image-placeholder-icon">&#128444;</span><span>이미지 준비 중</span></div>';
    html += '</div>';
  }

  // Passage
  if (q.passage) {
    html += '<div class="q-passage">' + escH(q.passage) + '</div>';
  }

  // Question text (fill-blank / vocab / story question)
  if (q.question) {
    html += '<div class="q-question">' + escH(q.question) + '</div>';
  }

  // Image choices (L12 type)
  if (q.image_choices) {
    html += '<div class="q-image-choices" id="img-choices">';
    for (var ic = 0; ic < q.image_choices.length; ic++) {
      var icClass = 'q-img-choice';
      if (answered) {
        if (ic === q.answer) icClass += ' correct';
        else if (ic === answers[q.id]) icClass += ' wrong';
      }
      html += '<div class="' + icClass + '" data-idx="' + ic + '" onclick="selectImgChoice(' + ic + ')">';
      html += '<span class="q-img-choice-num">' + (ic + 1) + '</span>';
      html += '<img src="../' + escH(q.image_choices[ic]) + '" alt="" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'">';
      html += '<div class="q-img-choice-placeholder" style="display:none">&#128444;</div>';
      html += '<div class="q-img-choice-label">' + escH(q.choices_desc[ic]) + '</div>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Text choices (non image-choice questions)
  if (!q.image_choices) {
    html += '<div class="q-choices" id="choices">';
    for (var i = 0; i < q.choices.length; i++) {
      var cls = 'q-choice';
      if (answered) {
        cls += ' answered';
        if (i === q.answer) cls += ' correct';
        else if (i === answers[q.id]) cls += ' wrong';
        else cls += ' dimmed';
      }
      var nums = ['①', '②', '③', '④'];
      var icon = '';
      if (answered && i === q.answer) icon = '&#10004;';
      else if (answered && i === answers[q.id] && i !== q.answer) icon = '&#10008;';
      html += '<button class="' + cls + '" data-idx="' + i + '" onclick="selectChoice(' + i + ')">';
      html += '<span class="q-choice-num">' + nums[i] + '</span>';
      html += '<span class="q-choice-text">' + escH(q.choices[i]) + '</span>';
      html += '<span class="q-choice-icon">' + icon + '</span>';
      html += '</button>';
    }
    html += '</div>';
  }

  // Audio transcript (shown after answering listening)
  if (q.audio_text) {
    html += '<div class="q-transcript' + (answered ? ' show' : '') + '" id="transcript">';
    html += '<span class="q-transcript-label">&#128362; 음성 내용:</span>';
    html += escH(q.audio_text);
    html += '</div>';
  }

  // Explanation
  html += '<div class="q-explain' + (answered ? ' show' : '') + '" id="explain">';
  html += '<div class="q-explain-ko"><span class="q-explain-label">&#128161; 설명:</span> ' + escH(q.explanation_ko) + '</div>';
  html += '<div class="q-explain-ne"><span class="q-explain-label">&#127475;&#127477; नेपाली:</span> ' + escH(q.explanation_ne) + '</div>';
  html += '</div>';

  document.getElementById('q-card').innerHTML = html;

  // Nav buttons
  document.getElementById('btn-prev').disabled = currentIdx === 0;
  var btnNext = document.getElementById('btn-next');
  if (currentIdx === total - 1) {
    var allAnswered = true;
    for (var j = 0; j < questions.length; j++) {
      if (answers[questions[j].id] === undefined) { allAnswered = false; break; }
    }
    btnNext.textContent = '결과 보기 ★';
    btnNext.className = 'q-nav-btn btn-next' + (allAnswered ? ' ready' : '');
    btnNext.disabled = !allAnswered;
  } else {
    btnNext.textContent = '다음 \u2192';
    btnNext.className = 'q-nav-btn btn-next';
    btnNext.disabled = false;
  }
}

function selectChoice(idx) {
  var q = questions[currentIdx];
  if (answers[q.id] !== undefined) return;
  answers[q.id] = idx;
  renderQuestion();
}

function selectImgChoice(idx) {
  var q = questions[currentIdx];
  if (answers[q.id] !== undefined) return;
  answers[q.id] = idx;
  renderQuestion();
}

function toggleAudio() {
  var q = questions[currentIdx];
  if (!q.audio) return;
  var btn = document.getElementById('audio-btn');

  if (quizAudio && !quizAudio.paused) {
    quizAudio.pause();
    quizAudio.currentTime = 0;
    btn.classList.remove('playing');
    return;
  }

  stopAudio();
  quizAudio = new Audio('../' + q.audio);
  btn.classList.add('playing');
  quizAudio.onended = function() {
    btn.classList.remove('playing');
  };
  quizAudio.onerror = function() {
    btn.classList.remove('playing');
  };
  quizAudio.play();
}

function stopAudio() {
  if (quizAudio) {
    quizAudio.pause();
    quizAudio = null;
  }
}

function prevQ() {
  if (currentIdx > 0) {
    currentIdx--;
    renderQuestion();
  }
}

function nextQ() {
  if (currentIdx < questions.length - 1) {
    currentIdx++;
    renderQuestion();
  } else {
    showResults();
  }
}

function showResults() {
  stopAudio();
  document.getElementById('quiz-screen').style.display = 'none';
  document.getElementById('results-screen').style.display = 'block';

  var correct = 0;
  for (var i = 0; i < questions.length; i++) {
    if (answers[questions[i].id] === questions[i].answer) correct++;
  }
  var total = questions.length;
  var pct = Math.round(correct / total * 100);

  // Grade
  var grade, gradeColor, msg;
  if (pct >= 90) { grade = 'A+'; gradeColor = '#4caf50'; msg = '아주 잘했습니다! 완벽해요!'; }
  else if (pct >= 80) { grade = 'A'; gradeColor = '#4caf50'; msg = '잘했습니다! 거의 다 맞았어요!'; }
  else if (pct >= 70) { grade = 'B'; gradeColor = '#2196f3'; msg = '좋습니다! 조금만 더 연습하세요!'; }
  else if (pct >= 60) { grade = 'C'; gradeColor = '#ff9800'; msg = '괜찮습니다! 틀린 문제를 다시 보세요.'; }
  else { grade = 'D'; gradeColor = '#e94560'; msg = '더 연습이 필요해요. 다시 도전하세요!'; }

  // Circle
  var radius = 65;
  var circum = 2 * Math.PI * radius;
  var offset = circum - (pct / 100) * circum;

  var html = '<div class="results">';
  html += '<div class="results-circle-wrap">';
  html += '<svg class="results-circle" width="160" height="160">';
  html += '<circle class="results-circle-bg" cx="80" cy="80" r="' + radius + '"/>';
  html += '<circle class="results-circle-fg" cx="80" cy="80" r="' + radius + '" stroke="' + gradeColor + '" stroke-dasharray="' + circum + '" stroke-dashoffset="' + circum + '" id="score-ring"/>';
  html += '</svg>';
  html += '<div class="results-score">';
  html += '<div class="results-score-num">' + correct + '</div>';
  html += '<div class="results-score-total">/ ' + total + '</div>';
  html += '</div>';
  html += '</div>';
  html += '<div class="results-grade" style="color:' + gradeColor + '">' + grade + ' (' + pct + '%)</div>';
  html += '<div class="results-msg">' + escH(msg) + '</div>';

  // Breakdown
  html += '<div class="results-breakdown">';
  html += '<div class="results-breakdown-title">문제별 결과</div>';
  for (var j = 0; j < questions.length; j++) {
    var q = questions[j];
    var isCorrect = answers[q.id] === q.answer;
    var icon = isCorrect ? '&#9989;' : '&#10060;';
    var label = q.question || q.passage || q.instruction;
    if (label.length > 40) label = label.substring(0, 40) + '...';
    html += '<div class="results-item" onclick="reviewQ(' + j + ')">';
    html += '<span class="results-item-icon">' + icon + '</span>';
    html += '<span class="results-item-id">' + escH(q.id) + '</span>';
    html += '<span class="results-item-text">' + escH(label) + '</span>';
    html += '<span class="section-card-arrow">&#8250;</span>';
    html += '</div>';
  }
  html += '</div>';

  html += '<div class="results-btns">';
  html += '<button class="results-btn btn-home" onclick="goHome()">&#127968; 홈으로</button>';
  html += '<button class="results-btn btn-retry" onclick="retry()">&#128260; 다시 풀기</button>';
  html += '</div>';
  html += '</div>';

  document.getElementById('results-screen').innerHTML = html;

  // Animate ring
  setTimeout(function() {
    document.getElementById('score-ring').style.strokeDashoffset = offset;
  }, 100);
}

function reviewQ(idx) {
  currentIdx = idx;
  document.getElementById('results-screen').style.display = 'none';
  document.getElementById('quiz-screen').style.display = 'block';
  renderQuestion();
}

function retry() {
  answers = {};
  currentIdx = 0;
  document.getElementById('results-screen').style.display = 'none';
  document.getElementById('quiz-screen').style.display = 'block';
  renderQuestion();
}

function goHome() {
  stopAudio();
  answers = {};
  currentIdx = 0;
  questions = [];
  document.getElementById('results-screen').style.display = 'none';
  document.getElementById('quiz-screen').style.display = 'none';
  document.getElementById('start-screen').style.display = 'block';
}
</script>
</body>
</html>
