<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Drama TOPIK</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #222;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1a1a2e;
      padding: 12px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1px;
    }

    .logo .play { color: #e94560; }

    /* â”€â”€ Main â”€â”€ */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px;
    }

    /* â”€â”€ Player â”€â”€ */
    .player-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .player-wrap iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: 0;
    }

    .player-touch-overlay {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 5;
      cursor: pointer;
    }

    /* â”€â”€ Current subtitle overlay â”€â”€ */
    .now-playing {
      margin-top: 10px;
      background: #1a1a2e;
      border-radius: 10px;
      padding: 14px 16px;
      text-align: center;
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      overflow: hidden;
    }

    .now-ko {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.5;
    }

    .now-ne {
      font-size: 0.9rem;
      color: #aab;
      line-height: 1.4;
    }

    .now-placeholder {
      color: #667;
      font-size: 0.85rem;
    }

    /* â”€â”€ Subtitle List â”€â”€ */
    .sub-list-header {
      margin-top: 14px;
      padding: 0 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sub-list-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
    }

    .sub-count {
      font-size: 0.75rem;
      color: #999;
    }

    .font-controls {
      display: flex;
      gap: 4px;
    }

    .btn-font {
      background: #1a1a2e;
      border: none;
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-font:active {
      background: #ddd;
    }

    .sub-list {
      margin-top: 8px;
      max-height: calc(280px * var(--font-scale, 1));
      overflow-y: auto;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      scroll-behavior: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* â”€â”€ Subtitle Item â”€â”€ */
    .sub-item {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .sub-item:last-child { border-bottom: none; }

    .sub-row {
      display: flex;
      align-items: flex-start;
      padding: 12px 14px;
      cursor: pointer;
      gap: 10px;
    }

    .sub-row:active {
      background: #f5f5f5;
    }

    .sub-num {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #888;
      margin-top: 2px;
    }

    .sub-text {
      flex: 1;
      min-width: 0;
    }

    .sub-ko {
      font-size: calc(0.9rem * var(--font-scale, 1));
      font-weight: 700;
      color: #222;
      line-height: 1.5;
      word-break: keep-all;
    }

    .sub-ne {
      font-size: calc(0.8rem * var(--font-scale, 1));
      color: #888;
      line-height: 1.4;
      margin-top: 2px;
    }

    .sub-time {
      flex-shrink: 0;
      font-size: 0.7rem;
      color: #bbb;
      margin-top: 4px;
    }

    /* Active subtitle */
    .sub-item.active {
      background: #eef4ff;
    }

    .sub-item.active .sub-num {
      background: #2196f3;
      color: #fff;
    }

    .sub-item.active .sub-ko {
      color: #1565c0;
    }

    /* â”€â”€ Detail (accordion) â”€â”€ */
    .sub-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #f8f9fb;
    }

    .sub-detail.open {
      max-height: calc(500px * var(--font-scale, 1));
    }

    /* â”€â”€ Explanation buttons â”€â”€ */
    .explain-section {
      padding: 0 14px 10px 52px;
    }

    .explain-btns {
      display: flex;
      gap: 8px;
    }

    .btn-explain {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: calc(0.78rem * var(--font-scale, 1));
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-explain-kr {
      background: #2196f3;
      color: #fff;
    }

    .btn-explain-ne {
      background: #4caf50;
      color: #fff;
    }

    .btn-explain:disabled {
      background: #ccc;
      color: #999;
      cursor: not-allowed;
    }

    .btn-explain:not(:disabled):active {
      opacity: 0.8;
    }

    /* â”€â”€ Explain Overlay (in player area) â”€â”€ */
    .explain-overlay {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #1a1a2e;
      z-index: 10;
      flex-direction: column;
      border-radius: 12px;
    }

    .explain-overlay.open {
      display: flex;
    }

    .eo-header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      flex-shrink: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      gap: 8px;
    }

    .eo-title {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 700;
      color: #fff;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .eo-btn {
      flex-shrink: 0;
      border: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
    }

    .eo-btn:active {
      background: rgba(255,255,255,0.3);
    }

    .eo-btn.playing {
      background: #2196f3;
    }

    .eo-seekbar {
      flex-shrink: 0;
      padding: 6px 12px 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .eo-seek-time {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
      flex-shrink: 0;
      min-width: 32px;
      text-align: center;
    }

    .eo-seek-input {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.2);
      outline: none;
      cursor: pointer;
    }

    .eo-seek-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffc107;
      cursor: pointer;
    }

    .eo-seek-input::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffc107;
      border: none;
      cursor: pointer;
    }

    .eo-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .eo-para {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      line-height: 1.8;
      word-break: keep-all;
      padding: 6px 8px;
      border-radius: 6px;
      margin-bottom: 4px;
      transition: color 0.3s, background 0.3s;
    }

    .eo-para.active {
      color: #fff;
      background: rgba(255, 193, 7, 0.2);
      border-left: 3px solid #ffc107;
    }

    /* â”€â”€ Tip banner â”€â”€ */
    .tip-banner {
      margin-top: 8px;
      background: #e3f2fd;
      border-radius: 8px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: #1565c0;
      line-height: 1.5;
    }

    .tip-banner-text {
      flex: 1;
    }

    .tip-banner-close {
      flex-shrink: 0;
      border: none;
      background: none;
      color: #1565c0;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 4px;
      font-family: inherit;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (min-width: 480px) {
      .container { padding: 16px; }
      .now-ko { font-size: 1.2rem; }
    }

    @media (min-width: 640px) {
      header { padding: 14px 20px; }
      .logo { font-size: 1.5rem; }
    }

    /* â”€â”€ Loop state â”€â”€ */
    .sub-item.looping {
      background: #fff8e1;
    }

    .sub-item.looping .sub-num {
      background: #ff9800;
      color: #fff;
    }

    .sub-item.looping .sub-ko {
      color: #e65100;
    }

    .loop-badge {
      font-size: 0.7rem;
      color: #ff9800;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 4px;
    }

    /* â”€â”€ Loop control bar â”€â”€ */
    .loop-bar {
      display: none;
      margin-top: 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .loop-bar.active {
      display: flex;
    }

    .loop-bar .loop-info {
      flex: 1;
      font-size: 0.8rem;
      color: #555;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loop-bar .loop-info strong {
      color: #ff9800;
    }

    .btn-action {
      flex-shrink: 0;
      border: none;
      border-radius: 20px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-action:active {
      opacity: 0.8;
    }

    .btn-repeat {
      background: #ff9800;
      color: #fff;
    }

    .btn-speed {
      background: #607d8b;
      color: #fff;
    }

    .btn-play-all {
      background: #2196f3;
      color: #fff;
    }

    .btn-stop {
      background: #e94560;
      color: #fff;
    }

    /* scrollbar */
    .sub-list::-webkit-scrollbar { width: 4px; }
    .sub-list::-webkit-scrollbar-track { background: transparent; }
    .sub-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <div class="logo">K<span class="play">&#9654;</span>Drama TOPIK</div>
</header>

<div class="container">
  <div class="player-wrap" id="player-wrap">
    <div id="player"></div>
    <div class="player-touch-overlay" id="player-touch-overlay"></div>
    <div class="explain-overlay" id="explain-overlay">
      <div class="eo-header">
        <div class="eo-title" id="eo-title"></div>
        <button class="eo-btn" id="eo-play-btn" onclick="toggleModalAudio()">â–¶</button>
        <button class="eo-btn" onclick="closeExplainOverlay()">âœ•</button>
      </div>
      <div class="eo-seekbar">
        <span class="eo-seek-time" id="eo-cur-time">0:00</span>
        <input type="range" class="eo-seek-input" id="eo-seek" min="0" max="100" value="0" step="0.1">
        <span class="eo-seek-time" id="eo-dur-time">0:00</span>
      </div>
      <div class="eo-body" id="eo-body">
        <div id="eo-text"></div>
      </div>
    </div>
  </div>

  <div class="tip-banner" id="tip-banner" style="display:none">
    <div class="tip-banner-text">ğŸ’¡ ì˜ìƒ ìœ„ì— 'ë™ì˜ìƒ ë”ë³´ê¸°'ê°€ ëœ¨ë©´ âœ•ë¥¼ í•œë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê°™ì€ ë¬¸ì¥ì—ì„œëŠ” ë‹¤ì‹œ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    <button class="tip-banner-close" onclick="closeTipBanner()">âœ•</button>
  </div>

  <div class="now-playing" id="now-playing">
    <div class="now-placeholder" id="now-placeholder">ì˜ìƒì„ ì¬ìƒí•˜ë©´ ìë§‰ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
    <div class="now-ko" id="now-ko"></div>
    <div class="now-ne" id="now-ne"></div>
  </div>

  <div class="loop-bar" id="loop-bar">
    <div class="loop-info" id="loop-info"></div>
    <button class="btn-action btn-repeat" id="btn-repeat" onclick="startLoop()">ğŸ” ë°˜ë³µ</button>
    <button class="btn-action btn-play-all" id="btn-play-all" onclick="playAll()" style="display:none">â–¶ ì „ì²´</button>
    <button class="btn-action btn-speed" id="btn-speed" onclick="toggleSpeed()" style="display:none">ğŸ¢1x</button>
    <button class="btn-action btn-stop" id="btn-stop" onclick="stopLoop()" style="display:none">â¹ ì¤‘ì§€</button>
  </div>

  <div class="sub-list-header">
    <h2>ìë§‰ ëª©ë¡</h2>
    <div class="font-controls">
      <button class="btn-font" onclick="changeFontSize(-1)">A-</button>
      <button class="btn-font" onclick="changeFontSize(1)">A+</button>
    </div>
    <span class="sub-count" id="sub-count"></span>
  </div>

  <div class="sub-list" id="sub-list"></div>
</div>

<script>
var player;
var subtitles = [];
var explanationsMap = {};
var explainAudio = null;
var explainAudioId = null;
var explainAudioLang = null;
var explainParas = [];
var explainHighlightTimer = null;
var explainActivePara = -1;
var eoSeeking = false;
var subtitleTimer = null;
var lastSubId = -1;
var openDetailId = -1;
var currentSub = null;
var loopSub = null;
var loopPausing = false;
var loopPauseTimer = null;
var speedSteps = [1, 0.7, 0.5];
var speedIndex = 0;
var fontScales = [0.85, 1, 1.2, 1.4, 1.7, 2];
var fontLevel = 1; // index into fontScales, default=1 (1x)


function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function escHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function findSub(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return subtitles[i];
  }
  return null;
}

Promise.all([
  fetch('../data/subtitles.json').then(function(r){return r.json();}),
  fetch('../data/explanations.json').then(function(r){return r.json();})
]).then(function(results) {
  subtitles = results[0];
  explanationsMap = results[1];
  renderList();
});

function changeFontSize(dir) {
  var next = fontLevel + dir;
  if (next < 0 || next >= fontScales.length) return;
  fontLevel = next;
  document.documentElement.style.setProperty('--font-scale', fontScales[fontLevel]);
  // Re-scroll to current page since item heights changed
  if (currentPage !== -1) {
    var pageStart = currentPage * PAGE_SIZE;
    if (pageStart < subtitles.length) {
      var firstEl = document.getElementById('sub-' + subtitles[pageStart].id);
      if (firstEl) {
        var list = document.getElementById('sub-list');
        list.scrollTop = firstEl.offsetTop - list.offsetTop;
      }
    }
  }
}

function renderList() {
  var list = document.getElementById('sub-list');
  document.getElementById('sub-count').textContent = subtitles.length + 'ê°œ';
  var html = '';
  subtitles.forEach(function(sub) {
    html += '<div class="sub-item" id="sub-' + sub.id + '">' +
      '<div class="sub-row" onclick="onSubClick(' + sub.id + ')">' +
        '<div class="sub-num">' + sub.id + '</div>' +
        '<div class="sub-text">' +
          '<div class="sub-ko">' + escHtml(sub.ko) + '</div>' +
          '<div class="sub-ne">' + escHtml(sub.ne) + '</div>' +
        '</div>' +
        '<div class="loop-badge" id="loop-icon-' + sub.id + '"></div>' +
        '<div class="sub-time">' + formatTime(sub.s) + '</div>' +
      '</div>' +
      '<div class="sub-detail" id="detail-' + sub.id + '">' +
        buildDetail(sub.id) +
      '</div>' +
    '</div>';
  });
  list.innerHTML = html;
}

function buildDetail(id) {
  return buildExplainSection(id);
}

function padId(id) {
  var s = '' + id;
  while (s.length < 3) s = '0' + s;
  return s;
}

function buildExplainSection(id) {
  var hasData = explanationsMap[String(id)];
  var disabled = hasData ? '' : ' disabled';
  var html = '<div class="explain-section">';
  html += '<div class="explain-btns">';
  html += '<button class="btn-explain btn-explain-ne" onclick="openExplainOverlay(' + id + ',\'ne\')"' + disabled + '>ğŸ§ ë„¤íŒ”ì–´ ì„¤ëª…</button>';
  html += '<button class="btn-explain btn-explain-kr" onclick="openExplainOverlay(' + id + ',\'kr\')"' + disabled + '>ğŸ§ í•œêµ­ì–´ ì„¤ëª…</button>';
  html += '</div>';
  html += '</div>';
  return html;
}

function renderExplainParas(text) {
  var parts = text.split('\n\n');
  explainParas = parts;
  explainActivePara = -1;
  var container = document.getElementById('eo-text');
  var html = '';
  for (var i = 0; i < parts.length; i++) {
    html += '<div class="eo-para" id="eo-para-' + i + '">' + escHtml(parts[i]) + '</div>';
  }
  container.innerHTML = html;
}

function startExplainHighlight() {
  stopExplainHighlight();
  explainHighlightTimer = setInterval(updateExplainHighlight, 200);
}

function stopExplainHighlight() {
  if (explainHighlightTimer) {
    clearInterval(explainHighlightTimer);
    explainHighlightTimer = null;
  }
}

function fmtAudioTime(sec) {
  if (!sec || isNaN(sec)) return '0:00';
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function getParaIndexAtTime(t, dur) {
  var totalChars = 0;
  for (var i = 0; i < explainParas.length; i++) totalChars += explainParas[i].length;
  if (totalChars === 0) return 0;
  var cumChars = 0;
  for (var i = 0; i < explainParas.length; i++) {
    var paraEnd = ((cumChars + explainParas[i].length) / totalChars) * dur;
    if (t < paraEnd) return i;
    cumChars += explainParas[i].length;
  }
  return explainParas.length - 1;
}

function highlightPara(idx) {
  if (idx === explainActivePara) return;
  if (explainActivePara >= 0) {
    var old = document.getElementById('eo-para-' + explainActivePara);
    if (old) old.classList.remove('active');
  }
  explainActivePara = idx;
  var el = document.getElementById('eo-para-' + idx);
  if (el) {
    el.classList.add('active');
    var body = document.getElementById('eo-body');
    if (body) body.scrollTop = el.offsetTop - body.offsetTop - 10;
  }
}

function updateExplainHighlight() {
  if (!explainAudio || !explainAudio.duration) return;
  var t = explainAudio.currentTime;
  var dur = explainAudio.duration;

  // Update seekbar
  if (!eoSeeking) {
    var seek = document.getElementById('eo-seek');
    seek.max = dur;
    seek.value = t;
  }
  document.getElementById('eo-cur-time').textContent = fmtAudioTime(t);
  document.getElementById('eo-dur-time').textContent = fmtAudioTime(dur);

  // Update paragraph highlight
  if (!explainAudio.paused) {
    highlightPara(getParaIndexAtTime(t, dur));
  }
}

function openExplainOverlay(id, lang) {
  var data = explanationsMap[String(id)];
  if (!data) return;

  // Pause YouTube
  if (player && player.pauseVideo) player.pauseVideo();

  // Set title
  var title = lang === 'kr' ? 'ğŸ§ í•œêµ­ì–´ ì„¤ëª… #' + id : 'ğŸ§ ë„¤íŒ”ì–´ ì„¤ëª… #' + id;
  document.getElementById('eo-title').textContent = title;

  // Show overlay
  document.getElementById('explain-overlay').classList.add('open');

  var playBtn = document.getElementById('eo-play-btn');

  // Same id+lang: resume from where we left off
  if (explainAudio && explainAudioId === id && explainAudioLang === lang) {
    renderExplainParas(data[lang]);
    explainAudio.play();
    playBtn.textContent = 'â¸';
    playBtn.classList.add('playing');
    startExplainHighlight();
    return;
  }

  // Different id or lang: destroy old, start fresh
  destroyExplainAudio();
  renderExplainParas(data[lang]);
  explainAudioId = id;
  explainAudioLang = lang;
  var path = '../audio/' + lang + '/S01E01_' + padId(id) + '_' + lang + '.mp3';
  explainAudio = new Audio(path);
  playBtn.textContent = 'â¸';
  playBtn.classList.add('playing');

  explainAudio.onended = function() {
    playBtn.textContent = 'â–¶';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  };
  explainAudio.onerror = function() {
    playBtn.textContent = 'â–¶';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  };
  explainAudio.play();
  startExplainHighlight();
}

function closeExplainOverlay() {
  document.getElementById('explain-overlay').classList.remove('open');
  stopExplainHighlight();
  // Pause only, keep position
  if (explainAudio && !explainAudio.paused) {
    explainAudio.pause();
  }
  var playBtn = document.getElementById('eo-play-btn');
  playBtn.textContent = 'â–¶';
  playBtn.classList.remove('playing');
}

function toggleModalAudio() {
  if (!explainAudio) return;
  var playBtn = document.getElementById('eo-play-btn');
  if (explainAudio.paused) {
    explainAudio.play();
    playBtn.textContent = 'â¸';
    playBtn.classList.add('playing');
    startExplainHighlight();
  } else {
    explainAudio.pause();
    playBtn.textContent = 'â–¶';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  }
}

function destroyExplainAudio() {
  stopExplainHighlight();
  if (explainAudio) {
    explainAudio.pause();
    explainAudio = null;
  }
  explainAudioId = null;
  explainAudioLang = null;
  explainParas = [];
  explainActivePara = -1;
}

/* â”€â”€ Subtitle Click â”€â”€ */
var clickLock = false;

function onSubClick(id) {
  if (clickLock) return;
  clickLock = true;
  setTimeout(function(){ clickLock = false; }, 300);

  var sub = findSub(id);
  if (!sub) return;

  // Close previous detail (different subtitle)
  if (openDetailId !== -1 && openDetailId !== id) {
    closeDetail(openDetailId);
  }

  // Close explain overlay (pauses audio, keeps position)
  closeExplainOverlay();

  // Cancel any existing loop
  cancelLoop();

  // Set current subtitle for play-once
  currentSub = sub;
  openDetailId = id;

  // Seek + play (single play)
  if (player && player.seekTo) {
    player.seekTo(sub.s, true);
    player.playVideo();
  }
  showTouchOverlay(true);

  // Open detail
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.add('open');

  // Scroll to page group
  scrollToPage(id);

  // Show bar with repeat button
  showBar('once');

  updateNowPlaying(id);
}

function startLoop() {
  if (!currentSub) return;

  // Close explain overlay first (pause audio, keep position)
  closeExplainOverlay();

  loopSub = currentSub;
  loopPausing = false;

  // Seek to start and play
  if (player && player.seekTo) {
    player.seekTo(loopSub.s, true);
    player.playVideo();
  }

  // Loop visual on subtitle item
  var icon = document.getElementById('loop-icon-' + loopSub.id);
  if (icon) icon.textContent = 'ğŸ”';
  var item = document.getElementById('sub-' + loopSub.id);
  if (item) item.classList.add('looping');

  showBar('loop');
}

function toggleSpeed() {
  speedIndex = (speedIndex + 1) % speedSteps.length;
  var rate = speedSteps[speedIndex];
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(rate);
  }
  document.getElementById('btn-speed').textContent = 'ğŸ¢' + rate + 'x';
}

function resetSpeed() {
  speedIndex = 0;
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(1);
  }
  document.getElementById('btn-speed').textContent = 'ğŸ¢1x';
}

function stopLoop() {
  cancelLoop();
  resetSpeed();
  // Pause at current position
  if (player && player.pauseVideo) player.pauseVideo();
  // Stay on current subtitle with once-mode bar
  if (currentSub) {
    showBar('once');
    showTouchOverlay(true);
  }
}

function cancelLoop() {
  if (loopPauseTimer) {
    clearTimeout(loopPauseTimer);
    loopPauseTimer = null;
  }
  loopPausing = false;

  if (loopSub) {
    var icon = document.getElementById('loop-icon-' + loopSub.id);
    if (icon) icon.textContent = '';
    var item = document.getElementById('sub-' + loopSub.id);
    if (item) item.classList.remove('looping');
    loopSub = null;
  }
}

function resetAllState() {
  closeExplainOverlay();
  cancelLoop();
  resetSpeed();
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }
  currentSub = null;
  loopPausing = false;
  document.getElementById('loop-bar').classList.remove('active');
  showTouchOverlay(false);
}

function playAll() {
  resetAllState();
  // Play from current position
  if (player && player.playVideo) player.playVideo();
}

function showBar(mode) {
  var bar = document.getElementById('loop-bar');
  var info = document.getElementById('loop-info');
  var btnRepeat = document.getElementById('btn-repeat');
  var btnPlayAll = document.getElementById('btn-play-all');
  var btnSpeed = document.getElementById('btn-speed');
  var btnStop = document.getElementById('btn-stop');
  var sub = currentSub;
  if (!sub) return;

  bar.classList.add('active');
  var label = '#' + sub.id + ' ' + escHtml(sub.ko.substring(0, 25)) + (sub.ko.length > 25 ? '...' : '');

  if (mode === 'once') {
    info.innerHTML = '<strong>â–¶ ì¬ìƒ ì¤‘</strong> ' + label;
    btnRepeat.style.display = '';
    btnPlayAll.style.display = '';
    btnSpeed.style.display = 'none';
    btnStop.style.display = 'none';
  } else {
    info.innerHTML = '<strong>ğŸ” ë°˜ë³µ ì¬ìƒ ì¤‘</strong> ' + label;
    btnRepeat.style.display = 'none';
    btnPlayAll.style.display = 'none';
    btnSpeed.style.display = '';
    btnStop.style.display = '';
  }
}

function closeDetail(id) {
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.remove('open');
}

function closeAllDetails() {
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }
}

function updateNowPlaying(id) {
  var sub = findSub(id);
  if (!sub) return;
  document.getElementById('now-ko').textContent = sub.ko;
  document.getElementById('now-ne').textContent = sub.ne;
  document.getElementById('now-placeholder').style.display = 'none';
}

/* â”€â”€ YouTube â”€â”€ */
var tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: 'srN85EUD1kI',
    playerVars: { rel: 0, modestbranding: 1, playsinline: 1 },
    events: {
      onStateChange: onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    startSubtitleSync();
    showTouchOverlay(true);
  } else if (event.data === YT.PlayerState.PAUSED) {
    stopSubtitleSync();
    showTouchOverlay(true);
  }
}

function showTouchOverlay(show) {
  var ov = document.getElementById('player-touch-overlay');
  // Show overlay when in custom mode (currentSub or loopSub active)
  ov.style.display = (currentSub || loopSub) && show ? 'block' : 'none';
}

function startSubtitleSync() {
  stopSubtitleSync();
  subtitleTimer = setInterval(updateSubtitle, 200);
}

function stopSubtitleSync() {
  if (subtitleTimer) {
    clearInterval(subtitleTimer);
    subtitleTimer = null;
  }
}

function updateSubtitle() {
  var t = player.getCurrentTime();

  // Play-once: pause at end of segment
  if (currentSub && !loopSub && t >= currentSub.e) {
    player.pauseVideo();
    var info = document.getElementById('loop-info');
    var label = '#' + currentSub.id + ' ' + escHtml(currentSub.ko.substring(0, 25)) + (currentSub.ko.length > 25 ? '...' : '');
    info.innerHTML = '<strong>âœ“ ì¬ìƒ ì™„ë£Œ</strong> ' + label;
    return;
  }

  // Loop: seek to start immediately, then pause 0.7s before playing
  if (loopSub && !loopPausing && t >= loopSub.e) {
    loopPausing = true;
    player.seekTo(loopSub.s, true);
    player.pauseVideo();
    loopPauseTimer = setTimeout(function() {
      if (loopSub) {
        player.playVideo();
        loopPausing = false;
      }
    }, 700);
    return;
  }

  var found = null;
  for (var i = 0; i < subtitles.length; i++) {
    if (t >= subtitles[i].s && t < subtitles[i].e) {
      found = subtitles[i];
      break;
    }
  }

  if (found && found.id !== lastSubId) {
    lastSubId = found.id;
    updateNowPlaying(found.id);
    highlightSub(found.id);
  } else if (!found && lastSubId !== -1) {
    lastSubId = -1;
    document.getElementById('now-ko').textContent = '';
    document.getElementById('now-ne').textContent = '';
    clearHighlight();
  }
}

var PAGE_SIZE = 4;
var currentPage = -1;

function getPage(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return Math.floor(i / PAGE_SIZE);
  }
  return -1;
}

function scrollToPage(id) {
  var page = getPage(id);
  if (page === -1 || page === currentPage) return;
  currentPage = page;
  var pageStart = page * PAGE_SIZE;
  var firstEl = document.getElementById('sub-' + subtitles[pageStart].id);
  if (firstEl) {
    var list = document.getElementById('sub-list');
    list.scrollTop = firstEl.offsetTop - list.offsetTop;
  }
}

var activeEl = null;

function highlightSub(id) {
  if (activeEl) activeEl.classList.remove('active');
  var el = document.getElementById('sub-' + id);
  if (el) {
    el.classList.add('active');
    activeEl = el;
    if (!loopSub) {
      scrollToPage(id);
    }
  }
}

function clearHighlight() {
  if (activeEl) {
    activeEl.classList.remove('active');
    activeEl = null;
  }
}

/* â”€â”€ Seekbar events â”€â”€ */
(function() {
  var seek = document.getElementById('eo-seek');
  seek.addEventListener('input', function() {
    eoSeeking = true;
    if (explainAudio && explainAudio.duration) {
      document.getElementById('eo-cur-time').textContent = fmtAudioTime(Number(seek.value));
      highlightPara(getParaIndexAtTime(Number(seek.value), explainAudio.duration));
    }
  });
  seek.addEventListener('change', function() {
    if (explainAudio && explainAudio.duration) {
      explainAudio.currentTime = Number(seek.value);
    }
    eoSeeking = false;
  });
})();

/* â”€â”€ User play/pause toggle â”€â”€ */
function userTogglePlay() {
  if (!player || !player.getPlayerState) return;
  var state = player.getPlayerState();
  if (state === YT.PlayerState.PLAYING) {
    // Always just pause, keep all state
    player.pauseVideo();
  } else {
    // Inside a subtitle: just resume, keep loop/sub state
    // Outside: free play
    if (!currentSub && !loopSub) {
      // No custom state, just play
    }
    player.playVideo();
  }
}

/* â”€â”€ Player touch overlay click â”€â”€ */
document.getElementById('player-touch-overlay').addEventListener('click', function() {
  userTogglePlay();
});

/* â”€â”€ Blur YouTube iframe to prevent spacebar conflict â”€â”€ */
window.addEventListener('blur', function() {
  setTimeout(function() {
    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
      document.activeElement.blur();
    }
  }, 0);
});

/* â”€â”€ Keyboard shortcuts â”€â”€ */
document.addEventListener('keydown', function(e) {
  if (e.code !== 'Space') return;
  var tag = e.target.tagName;
  if (tag === 'INPUT' || tag === 'BUTTON' || tag === 'TEXTAREA') return;
  e.preventDefault();
  userTogglePlay();
});

/* â”€â”€ Tip banner â”€â”€ */
if (!localStorage.getItem('tipBannerClosed')) {
  document.getElementById('tip-banner').style.display = 'flex';
}
function closeTipBanner() {
  document.getElementById('tip-banner').style.display = 'none';
  localStorage.setItem('tipBannerClosed', '1');
}

/* â”€â”€ Service Worker â”€â”€ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
