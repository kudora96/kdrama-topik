<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Drama TOPIK</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #222;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1a1a2e;
      padding: 12px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1px;
    }

    .logo .play { color: #e94560; }

    /* â”€â”€ Main â”€â”€ */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px;
    }

    /* â”€â”€ Player â”€â”€ */
    .player-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .player-wrap iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: 0;
    }

    /* â”€â”€ Current subtitle overlay â”€â”€ */
    .now-playing {
      margin-top: 10px;
      background: #1a1a2e;
      border-radius: 10px;
      padding: 14px 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }

    .now-ko {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.5;
    }

    .now-ne {
      font-size: 0.9rem;
      color: #aab;
      line-height: 1.4;
    }

    .now-placeholder {
      color: #667;
      font-size: 0.85rem;
    }

    /* â”€â”€ Subtitle List â”€â”€ */
    .sub-list-header {
      margin-top: 14px;
      padding: 0 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sub-list-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
    }

    .sub-count {
      font-size: 0.75rem;
      color: #999;
    }

    .font-controls {
      display: flex;
      gap: 4px;
    }

    .btn-font {
      background: #1a1a2e;
      border: none;
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-font:active {
      background: #ddd;
    }

    /* Font size levels */
    .sub-list.font-small .sub-ko { font-size: 0.8rem; }
    .sub-list.font-small .sub-ne { font-size: 0.7rem; }
    .sub-list.font-small .d-value { font-size: 0.72rem; }
    .sub-list.font-small .d-label { font-size: 0.6rem; }

    .sub-list.font-large .sub-ko { font-size: 1.05rem; }
    .sub-list.font-large .sub-ne { font-size: 0.95rem; }
    .sub-list.font-large .d-value { font-size: 0.95rem; }
    .sub-list.font-large .d-label { font-size: 0.8rem; }

    .sub-list {
      margin-top: 8px;
      max-height: 280px;
      overflow-y: auto;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      scroll-behavior: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* â”€â”€ Subtitle Item â”€â”€ */
    .sub-item {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .sub-item:last-child { border-bottom: none; }

    .sub-row {
      display: flex;
      align-items: flex-start;
      padding: 12px 14px;
      cursor: pointer;
      gap: 10px;
    }

    .sub-row:active {
      background: #f5f5f5;
    }

    .sub-num {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #888;
      margin-top: 2px;
    }

    .sub-text {
      flex: 1;
      min-width: 0;
    }

    .sub-ko {
      font-size: 0.9rem;
      font-weight: 700;
      color: #222;
      line-height: 1.5;
      word-break: keep-all;
    }

    .sub-ne {
      font-size: 0.8rem;
      color: #888;
      line-height: 1.4;
      margin-top: 2px;
    }

    .sub-time {
      flex-shrink: 0;
      font-size: 0.7rem;
      color: #bbb;
      margin-top: 4px;
    }

    /* Active subtitle */
    .sub-item.active {
      background: #eef4ff;
    }

    .sub-item.active .sub-num {
      background: #2196f3;
      color: #fff;
    }

    .sub-item.active .sub-ko {
      color: #1565c0;
    }

    /* â”€â”€ Detail (accordion) â”€â”€ */
    .sub-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #f8f9fb;
    }

    .sub-detail.open {
      max-height: 500px;
    }

    .detail-grid {
      padding: 4px 14px 14px 52px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .d-card {
      background: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      border-left: 3px solid #ddd;
    }

    .d-card.tip-card { border-left-color: #ff9800; }
    .d-card.grammar-card { border-left-color: #2196f3; }
    .d-card.topik-card { border-left-color: #9c27b0; }
    .d-card.vocab-card { border-left-color: #4caf50; }

    .d-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .d-value {
      font-size: 0.82rem;
      color: #333;
      line-height: 1.5;
    }

    .topik-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.8rem;
      color: #fff;
    }

    .topik-1 { background: #4caf50; }
    .topik-2 { background: #2196f3; }
    .topik-3 { background: #ff9800; }
    .topik-4 { background: #f44336; }
    .topik-5 { background: #9c27b0; }
    .topik-6 { background: #333; }

    .vocab-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 0;
    }

    .vocab-row .v-ko { font-weight: 700; }
    .vocab-row .v-ne { color: #777; }

    .vocab-row .v-lvl {
      font-size: 0.65rem;
      padding: 1px 6px;
      border-radius: 6px;
      color: #fff;
      flex-shrink: 0;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (min-width: 480px) {
      .container { padding: 16px; }
      .detail-grid { grid-template-columns: 1fr 1fr; }
      .now-ko { font-size: 1.2rem; }
    }

    @media (min-width: 640px) {
      header { padding: 14px 20px; }
      .logo { font-size: 1.5rem; }
    }

    /* â”€â”€ Loop state â”€â”€ */
    .sub-item.looping {
      background: #fff8e1;
    }

    .sub-item.looping .sub-num {
      background: #ff9800;
      color: #fff;
    }

    .sub-item.looping .sub-ko {
      color: #e65100;
    }

    .loop-badge {
      font-size: 0.7rem;
      color: #ff9800;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 4px;
    }

    /* â”€â”€ Loop control bar â”€â”€ */
    .loop-bar {
      display: none;
      margin-top: 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .loop-bar.active {
      display: flex;
    }

    .loop-bar .loop-info {
      flex: 1;
      font-size: 0.8rem;
      color: #555;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loop-bar .loop-info strong {
      color: #ff9800;
    }

    .btn-action {
      flex-shrink: 0;
      border: none;
      border-radius: 20px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-action:active {
      opacity: 0.8;
    }

    .btn-repeat {
      background: #ff9800;
      color: #fff;
    }

    .btn-speed {
      background: #607d8b;
      color: #fff;
    }

    .btn-stop {
      background: #e94560;
      color: #fff;
    }

    /* scrollbar */
    .sub-list::-webkit-scrollbar { width: 4px; }
    .sub-list::-webkit-scrollbar-track { background: transparent; }
    .sub-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <div class="logo">K<span class="play">&#9654;</span>Drama TOPIK</div>
</header>

<div class="container">
  <div class="player-wrap">
    <div id="player"></div>
  </div>

  <div class="now-playing" id="now-playing">
    <div class="now-placeholder" id="now-placeholder">ì˜ìƒì„ ì¬ìƒí•˜ë©´ ìë§‰ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
    <div class="now-ko" id="now-ko"></div>
    <div class="now-ne" id="now-ne"></div>
  </div>

  <div class="loop-bar" id="loop-bar">
    <div class="loop-info" id="loop-info"></div>
    <button class="btn-action btn-repeat" id="btn-repeat" onclick="startLoop()">ğŸ” ë°˜ë³µ</button>
    <button class="btn-action btn-speed" id="btn-speed" onclick="toggleSpeed()" style="display:none">ğŸ¢1x</button>
    <button class="btn-action btn-stop" id="btn-stop" onclick="stopLoop()" style="display:none">â¹ ì¤‘ì§€</button>
  </div>

  <div class="sub-list-header">
    <h2>ìë§‰ ëª©ë¡</h2>
    <div class="font-controls">
      <button class="btn-font" onclick="changeFontSize(-1)">A-</button>
      <button class="btn-font" onclick="changeFontSize(1)">A+</button>
    </div>
    <span class="sub-count" id="sub-count"></span>
  </div>

  <div class="sub-list" id="sub-list"></div>
</div>

<script>
var player;
var subtitles = [];
var analysisMap = {};
var subtitleTimer = null;
var lastSubId = -1;
var openDetailId = -1;
var currentSub = null;
var loopSub = null;
var loopPausing = false;
var loopPauseTimer = null;
var speedSteps = [1, 0.7, 0.5];
var speedIndex = 0;
var fontLevel = 1; // 0=small, 1=normal, 2=large
var fontClasses = ['font-small', '', 'font-large'];

var topikCls = {1:'topik-1',2:'topik-2',3:'topik-3',4:'topik-4',5:'topik-5',6:'topik-6'};

function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function escHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function findSub(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return subtitles[i];
  }
  return null;
}

Promise.all([
  fetch('../data/subtitles.json').then(function(r){return r.json();}),
  fetch('../data/analysis.json').then(function(r){return r.json();})
]).then(function(results) {
  subtitles = results[0];
  results[1].forEach(function(a){ analysisMap[a.id] = a; });
  renderList();
});

function changeFontSize(dir) {
  var next = fontLevel + dir;
  if (next < 0 || next > 2) return;
  fontLevel = next;
  var list = document.getElementById('sub-list');
  list.classList.remove('font-small', 'font-large');
  if (fontClasses[fontLevel]) list.classList.add(fontClasses[fontLevel]);
}

function renderList() {
  var list = document.getElementById('sub-list');
  document.getElementById('sub-count').textContent = subtitles.length + 'ê°œ';
  var html = '';
  subtitles.forEach(function(sub) {
    html += '<div class="sub-item" id="sub-' + sub.id + '">' +
      '<div class="sub-row" onclick="onSubClick(' + sub.id + ')">' +
        '<div class="sub-num">' + sub.id + '</div>' +
        '<div class="sub-text">' +
          '<div class="sub-ko">' + escHtml(sub.ko) + '</div>' +
          '<div class="sub-ne">' + escHtml(sub.ne) + '</div>' +
        '</div>' +
        '<div class="loop-badge" id="loop-icon-' + sub.id + '"></div>' +
        '<div class="sub-time">' + formatTime(sub.s) + '</div>' +
      '</div>' +
      '<div class="sub-detail" id="detail-' + sub.id + '">' +
        buildDetail(sub.id) +
      '</div>' +
    '</div>';
  });
  list.innerHTML = html;
}

function buildDetail(id) {
  var a = analysisMap[id];
  if (!a) return '<div class="detail-grid"><div class="d-card"><div class="d-value" style="color:#999">ë¶„ì„ ë°ì´í„° ì—†ìŒ</div></div></div>';

  var html = '<div class="detail-grid">';

  if (a.tip) {
    html += '<div class="d-card tip-card">' +
      '<div class="d-label">ğŸ’¡ íŒ (ë¶í•œì‹ â†’ í‘œì¤€ì–´)</div>' +
      '<div class="d-value">' + escHtml(a.tip) + '</div></div>';
  }

  html += '<div class="d-card grammar-card">' +
    '<div class="d-label">ğŸ“ ë¬¸ë²•</div>' +
    '<div class="d-value">' + escHtml(a.grammar) + '</div></div>';

  var cls = topikCls[a.topik] || 'topik-2';
  html += '<div class="d-card topik-card">' +
    '<div class="d-label">ğŸ“Š TOPIK ë ˆë²¨</div>' +
    '<div class="d-value"><span class="topik-badge ' + cls + '">TOPIK ' + a.topik + '</span></div></div>';

  if (a.vocab && a.vocab.length > 0) {
    html += '<div class="d-card vocab-card">' +
      '<div class="d-label">ğŸ“– ì–´íœ˜</div><div class="d-value">';
    a.vocab.forEach(function(v) {
      var vc = topikCls[v.topik] || 'topik-2';
      html += '<div class="vocab-row">' +
        '<span class="v-ko">' + escHtml(v.ko) + '</span> ' +
        '<span class="v-ne">' + escHtml(v.ne) + '</span>' +
        '<span class="v-lvl ' + vc + '">' + v.topik + '</span></div>';
    });
    html += '</div></div>';
  }

  html += '</div>';
  return html;
}

/* â”€â”€ Subtitle Click â”€â”€ */
var clickLock = false;

function onSubClick(id) {
  if (clickLock) return;
  clickLock = true;
  setTimeout(function(){ clickLock = false; }, 300);

  var sub = findSub(id);
  if (!sub) return;

  // Close previous detail (different subtitle)
  if (openDetailId !== -1 && openDetailId !== id) {
    closeDetail(openDetailId);
  }

  // Cancel any existing loop
  cancelLoop();

  // Set current subtitle for play-once
  currentSub = sub;
  openDetailId = id;

  // Seek + play (single play)
  if (player && player.seekTo) {
    player.seekTo(sub.s, true);
    player.playVideo();
  }

  // Open detail
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.add('open');

  // Scroll to page group
  scrollToPage(id);

  // Show bar with repeat button
  showBar('once');

  updateNowPlaying(id);
}

function startLoop() {
  if (!currentSub) return;
  loopSub = currentSub;
  loopPausing = false;

  // Seek to start and play
  if (player && player.seekTo) {
    player.seekTo(loopSub.s, true);
    player.playVideo();
  }

  // Loop visual on subtitle item
  var icon = document.getElementById('loop-icon-' + loopSub.id);
  if (icon) icon.textContent = 'ğŸ”';
  var item = document.getElementById('sub-' + loopSub.id);
  if (item) item.classList.add('looping');

  showBar('loop');
}

function toggleSpeed() {
  speedIndex = (speedIndex + 1) % speedSteps.length;
  var rate = speedSteps[speedIndex];
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(rate);
  }
  document.getElementById('btn-speed').textContent = 'ğŸ¢' + rate + 'x';
}

function resetSpeed() {
  speedIndex = 0;
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(1);
  }
  document.getElementById('btn-speed').textContent = 'ğŸ¢1x';
}

function stopLoop() {
  cancelLoop();
  resetSpeed();

  // Close detail
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }

  currentSub = null;
  document.getElementById('loop-bar').classList.remove('active');

  // Continue playing
  if (player && player.playVideo) {
    player.playVideo();
  }
}

function cancelLoop() {
  if (loopPauseTimer) {
    clearTimeout(loopPauseTimer);
    loopPauseTimer = null;
  }
  loopPausing = false;

  if (loopSub) {
    var icon = document.getElementById('loop-icon-' + loopSub.id);
    if (icon) icon.textContent = '';
    var item = document.getElementById('sub-' + loopSub.id);
    if (item) item.classList.remove('looping');
    loopSub = null;
  }
}

function showBar(mode) {
  var bar = document.getElementById('loop-bar');
  var info = document.getElementById('loop-info');
  var btnRepeat = document.getElementById('btn-repeat');
  var btnSpeed = document.getElementById('btn-speed');
  var btnStop = document.getElementById('btn-stop');
  var sub = currentSub;
  if (!sub) return;

  bar.classList.add('active');
  var label = '#' + sub.id + ' ' + escHtml(sub.ko.substring(0, 25)) + (sub.ko.length > 25 ? '...' : '');

  if (mode === 'once') {
    info.innerHTML = '<strong>â–¶ ì¬ìƒ ì¤‘</strong> ' + label;
    btnRepeat.style.display = '';
    btnSpeed.style.display = 'none';
    btnStop.style.display = 'none';
  } else {
    info.innerHTML = '<strong>ğŸ” ë°˜ë³µ ì¬ìƒ ì¤‘</strong> ' + label;
    btnRepeat.style.display = 'none';
    btnSpeed.style.display = '';
    btnStop.style.display = '';
  }
}

function closeDetail(id) {
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.remove('open');
}

function closeAllDetails() {
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }
}

function updateNowPlaying(id) {
  var sub = findSub(id);
  if (!sub) return;
  document.getElementById('now-ko').textContent = sub.ko;
  document.getElementById('now-ne').textContent = sub.ne;
  document.getElementById('now-placeholder').style.display = 'none';
}

/* â”€â”€ YouTube â”€â”€ */
var tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: 'srN85EUD1kI',
    playerVars: { rel: 0, modestbranding: 1, playsinline: 1 },
    events: {
      onStateChange: onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    startSubtitleSync();
  } else if (event.data === YT.PlayerState.PAUSED) {
    stopSubtitleSync();
  }
}

function startSubtitleSync() {
  stopSubtitleSync();
  subtitleTimer = setInterval(updateSubtitle, 200);
}

function stopSubtitleSync() {
  if (subtitleTimer) {
    clearInterval(subtitleTimer);
    subtitleTimer = null;
  }
}

function updateSubtitle() {
  var t = player.getCurrentTime();

  // Play-once: pause at end of segment
  if (currentSub && !loopSub && t >= currentSub.e) {
    player.pauseVideo();
    var info = document.getElementById('loop-info');
    var label = '#' + currentSub.id + ' ' + escHtml(currentSub.ko.substring(0, 25)) + (currentSub.ko.length > 25 ? '...' : '');
    info.innerHTML = '<strong>âœ“ ì¬ìƒ ì™„ë£Œ</strong> ' + label;
    return;
  }

  // Loop: seek to start immediately, then pause 0.7s before playing
  if (loopSub && !loopPausing && t >= loopSub.e) {
    loopPausing = true;
    player.seekTo(loopSub.s, true);
    player.pauseVideo();
    loopPauseTimer = setTimeout(function() {
      if (loopSub) {
        player.playVideo();
        loopPausing = false;
      }
    }, 700);
    return;
  }

  var found = null;
  for (var i = 0; i < subtitles.length; i++) {
    if (t >= subtitles[i].s && t < subtitles[i].e) {
      found = subtitles[i];
      break;
    }
  }

  if (found && found.id !== lastSubId) {
    lastSubId = found.id;
    updateNowPlaying(found.id);
    highlightSub(found.id);
  } else if (!found && lastSubId !== -1) {
    lastSubId = -1;
    document.getElementById('now-ko').textContent = '';
    document.getElementById('now-ne').textContent = '';
    clearHighlight();
  }
}

var PAGE_SIZE = 4;
var currentPage = -1;

function getPage(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return Math.floor(i / PAGE_SIZE);
  }
  return -1;
}

function scrollToPage(id) {
  var page = getPage(id);
  if (page === -1 || page === currentPage) return;
  currentPage = page;
  var pageStart = page * PAGE_SIZE;
  var firstEl = document.getElementById('sub-' + subtitles[pageStart].id);
  if (firstEl) {
    var list = document.getElementById('sub-list');
    list.scrollTop = firstEl.offsetTop - list.offsetTop;
  }
}

function highlightSub(id) {
  clearHighlight();
  var el = document.getElementById('sub-' + id);
  if (el) {
    el.classList.add('active');
    if (!loopSub) {
      scrollToPage(id);
    }
  }
}

function clearHighlight() {
  var prev = document.querySelector('.sub-item.active');
  if (prev) prev.classList.remove('active');
}

/* â”€â”€ Service Worker â”€â”€ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
