<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-Drama TOPIK</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f2f5;
      color: #222;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: #1a1a2e;
      padding: 12px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1px;
    }

    .logo .play { color: #e94560; }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px;
    }

    /* ‚îÄ‚îÄ Player ‚îÄ‚îÄ */
    .player-wrap {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .player-wrap iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: 0;
    }

    .player-touch-overlay {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 5;
      cursor: pointer;
    }

    /* ‚îÄ‚îÄ Current subtitle overlay ‚îÄ‚îÄ */
    .now-playing {
      margin-top: 10px;
      background: #1a1a2e;
      border-radius: 10px;
      padding: 14px 16px;
      text-align: center;
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      overflow: hidden;
    }

    .now-ko {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.5;
    }

    .now-ne {
      font-size: 0.9rem;
      color: #aab;
      line-height: 1.4;
    }

    .now-placeholder {
      color: #667;
      font-size: 0.85rem;
    }

    /* ‚îÄ‚îÄ Subtitle List ‚îÄ‚îÄ */
    .sub-list-header {
      margin-top: 14px;
      padding: 0 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sub-list-header h2 {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
    }

    .sub-count {
      font-size: 0.75rem;
      color: #999;
    }

    .font-controls {
      display: flex;
      gap: 4px;
    }

    .btn-font {
      background: #1a1a2e;
      border: none;
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-font:active {
      background: #ddd;
    }

    .sub-list {
      margin-top: 8px;
      max-height: calc(280px * var(--font-scale, 1));
      overflow-y: auto;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      scroll-behavior: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ‚îÄ‚îÄ Subtitle Item ‚îÄ‚îÄ */
    .sub-item {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .sub-item:last-child { border-bottom: none; }

    .sub-row {
      display: flex;
      align-items: flex-start;
      padding: 12px 14px;
      cursor: pointer;
      gap: 10px;
    }

    .sub-row:active {
      background: #f5f5f5;
    }

    .sub-num {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #888;
      margin-top: 2px;
    }

    .sub-text {
      flex: 1;
      min-width: 0;
    }

    .sub-ko {
      font-size: calc(0.9rem * var(--font-scale, 1));
      font-weight: 700;
      color: #222;
      line-height: 1.5;
      word-break: keep-all;
    }

    .sub-ne {
      font-size: calc(0.8rem * var(--font-scale, 1));
      color: #888;
      line-height: 1.4;
      margin-top: 2px;
    }

    .sub-time {
      flex-shrink: 0;
      font-size: 0.7rem;
      color: #bbb;
      margin-top: 4px;
    }

    /* Active subtitle */
    .sub-item.active {
      background: #eef4ff;
    }

    .sub-item.active .sub-num {
      background: #2196f3;
      color: #fff;
    }

    .sub-item.active .sub-ko {
      color: #1565c0;
    }

    /* ‚îÄ‚îÄ Detail (accordion) ‚îÄ‚îÄ */
    .sub-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #f8f9fb;
    }

    .sub-detail.open {
      max-height: calc(500px * var(--font-scale, 1));
    }

    /* ‚îÄ‚îÄ Explanation buttons ‚îÄ‚îÄ */
    .explain-section {
      padding: 0 14px 10px 52px;
    }

    .explain-btns {
      display: flex;
      gap: 8px;
    }

    .btn-explain {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: calc(0.78rem * var(--font-scale, 1));
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-explain-kr {
      background: #2196f3;
      color: #fff;
    }

    .btn-explain-ne {
      background: #4caf50;
      color: #fff;
    }

    .btn-explain:disabled {
      background: #ccc;
      color: #999;
      cursor: not-allowed;
    }

    .btn-explain:not(:disabled):active {
      opacity: 0.8;
    }

    /* ‚îÄ‚îÄ Explain Overlay (in player area) ‚îÄ‚îÄ */
    .explain-overlay {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #FFFFFF;
      z-index: 10;
      flex-direction: column;
      border-radius: 12px;
    }

    .explain-overlay.open {
      display: flex;
    }

    .eo-header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      flex-shrink: 0;
      border-bottom: 1px solid #EEEEEE;
      gap: 8px;
    }

    .eo-title {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 700;
      color: #333333;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .eo-btn {
      flex-shrink: 0;
      border: none;
      background: #F0F0F0;
      color: #333333;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: inherit;
    }

    .eo-btn:active {
      background: #E0E0E0;
    }

    .eo-btn.playing {
      background: #2196F3;
      color: #fff;
    }

    .eo-seekbar {
      flex-shrink: 0;
      padding: 6px 12px 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .eo-seek-time {
      font-size: 0.7rem;
      color: #999999;
      flex-shrink: 0;
      min-width: 32px;
      text-align: center;
    }

    .eo-seek-input {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: #E0E0E0;
      outline: none;
      cursor: pointer;
    }

    .eo-seek-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #2196F3;
      cursor: pointer;
    }

    .eo-seek-input::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #2196F3;
      border: none;
      cursor: pointer;
    }

    .eo-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .eo-para {
      font-size: 0.85rem;
      color: #666666;
      line-height: 1.8;
      word-break: keep-all;
      padding: 6px 8px;
      border-radius: 6px;
      margin-bottom: 4px;
      transition: color 0.3s, background 0.3s;
    }

    .eo-para.active {
      color: #333333;
      background: #E3F2FD;
      border-left: 3px solid #2196F3;
    }

    /* ‚îÄ‚îÄ Tip banner ‚îÄ‚îÄ */
    .tip-banner {
      margin-top: 8px;
      background: #e3f2fd;
      border-radius: 10px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: #222;
      line-height: 1.5;
    }

    .tip-banner-text {
      flex: 1;
    }

    .tip-banner-close {
      flex-shrink: 0;
      border: none;
      background: none;
      color: #555;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0 4px;
      font-family: inherit;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (min-width: 480px) {
      .container { padding: 16px; }
      .now-ko { font-size: 1.2rem; }
    }

    @media (min-width: 640px) {
      header { padding: 14px 20px; }
      .logo { font-size: 1.5rem; }
    }

    /* ‚îÄ‚îÄ Loop state ‚îÄ‚îÄ */
    .sub-item.looping {
      background: #fff8e1;
    }

    .sub-item.looping .sub-num {
      background: #ff9800;
      color: #fff;
    }

    .sub-item.looping .sub-ko {
      color: #e65100;
    }

    .loop-badge {
      font-size: 0.7rem;
      color: #ff9800;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Loop control bar ‚îÄ‚îÄ */
    .loop-bar {
      display: none;
      margin-top: 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .loop-bar.active {
      display: flex;
    }

    .loop-bar .loop-info {
      flex: 1;
      font-size: 0.8rem;
      color: #555;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loop-bar .loop-info strong {
      color: #ff9800;
    }

    .btn-action {
      flex-shrink: 0;
      border: none;
      border-radius: 20px;
      padding: 7px 16px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-action:active {
      opacity: 0.8;
    }

    .btn-repeat {
      background: #ff9800;
      color: #fff;
    }

    .btn-speed {
      background: #607d8b;
      color: #fff;
    }

    .btn-play-all {
      background: #2196f3;
      color: #fff;
    }

    .btn-stop {
      background: #e94560;
      color: #fff;
    }

    /* scrollbar */
    .sub-list::-webkit-scrollbar { width: 4px; }
    .sub-list::-webkit-scrollbar-track { background: transparent; }
    .sub-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    /* ‚îÄ‚îÄ Quiz button ‚îÄ‚îÄ */
    .btn-explain-quiz {
      background: #F39C12;
      color: #fff;
    }

    /* ‚îÄ‚îÄ Quiz Overlay (flows outside player-wrap) ‚îÄ‚îÄ */
    .quiz-overlay {
      display: none;
      position: relative;
      background: #FFFFFF;
      border-radius: 12px;
      flex-direction: column;
      margin-top: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .quiz-overlay.open {
      display: flex;
    }

    .qo-header {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      flex-shrink: 0;
      border-bottom: 1px solid #EEEEEE;
      gap: 8px;
    }

    .qo-header-title {
      flex: 1;
      font-size: 20px;
      font-weight: 700;
      color: #333333;
    }

    .qo-theme-btn {
      flex-shrink: 0;
      border: none;
      background: #F5F5F5;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .qo-theme-btn:active { opacity: 0.7; }

    /* ‚îÄ‚îÄ Progress bar (dot per question) ‚îÄ‚îÄ */
    .qo-pbar {
      flex-shrink: 0;
      display: flex;
      gap: 3px;
      padding: 8px 14px 6px;
      justify-content: center;
    }

    .qo-dot {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: #E0E0E0;
      max-width: 32px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .qo-dot.current {
      background: #2196F3;
      box-shadow: 0 0 4px rgba(33,150,243,0.4);
    }

    .qo-dot.correct { background: #4CAF50; }
    .qo-dot.wrong { background: #F44336; }

    .qo-body {
      padding: 14px 16px;
    }

    .qo-progress {
      font-size: 20px;
      font-weight: 900;
      color: #333333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qo-progress-section {
      font-size: 13px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 10px;
      color: #fff;
    }

    .qo-progress-section.reading { background: #2196F3; }
    .qo-progress-section.listening { background: #9C27B0; }

    .qo-instruction {
      font-size: 18px;
      font-weight: 700;
      color: #333333;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .qo-image-wrap {
      margin-bottom: 12px;
      text-align: center;
    }

    .qo-image {
      max-width: 80%;
      max-height: 250px;
      object-fit: contain;
      border-radius: 8px;
      background: #F5F5F5;
    }

    .qo-image-placeholder {
      width: 80%;
      max-height: 250px;
      height: 120px;
      margin: 0 auto;
      background: #F5F5F5;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #BDBDBD;
    }

    .qo-passage {
      background: #F5F8FF;
      border: 1px solid #E3EEFF;
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 17px;
      line-height: 1.7;
      color: #333333;
      margin-bottom: 12px;
    }

    .qo-question {
      font-size: 18px;
      line-height: 1.7;
      color: #444444;
      margin-bottom: 12px;
    }

    .qo-blank {
      border-bottom: 2px solid #2196F3;
      padding: 0 8px;
      color: #2196F3;
    }

    .qo-audio-wrap { margin-bottom: 12px; }

    .qo-audio-btn {
      display: block;
      width: 100%;
      background: #F5F5F5;
      border: 1px solid #DDDDDD;
      border-radius: 8px;
      padding: 12px;
      font-size: 18px;
      font-weight: 700;
      color: #333333;
      cursor: pointer;
      font-family: inherit;
    }

    .qo-audio-btn:active { opacity: 0.8; }

    .qo-audio-btn.playing {
      background: #E8F5E9;
      border-color: #4CAF50;
      color: #2E7D32;
    }

    .qo-audio-text {
      font-size: 14px;
      color: #999999;
      margin-top: 6px;
      line-height: 1.5;
      padding: 8px 10px;
      background: #FAFAFA;
      border-radius: 6px;
    }

    .qo-choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .qo-choice {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: #F5F5F5;
      border: 2px solid #DDDDDD;
      border-radius: 8px;
      padding: 14px 16px;
      cursor: pointer;
      font-family: inherit;
      text-align: left;
      width: 100%;
      color: #333333;
    }

    .qo-choice:active:not(.checked) { background: #E3F2FD; }

    .qo-choice.selected {
      border-color: #2196F3;
      background: #E3F2FD;
    }

    .qo-choice.correct {
      border-color: #4CAF50;
      background: #E8F5E9;
      color: #1B5E20;
    }

    .qo-choice.wrong {
      border-color: #F44336;
      background: #FFEBEE;
      color: #B71C1C;
    }

    .qo-choice.dimmed { opacity: 0.4; }

    .qo-choice-num {
      flex-shrink: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .qo-choice-text {
      flex: 1;
      font-size: 18px;
      line-height: 1.5;
    }

    .qo-img-choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .qo-img-choice {
      background: #F5F5F5;
      border: 2px solid #DDDDDD;
      border-radius: 8px;
      cursor: pointer;
      overflow: hidden;
      text-align: center;
    }

    .qo-img-choice.selected { border-color: #2196F3; }
    .qo-img-choice.correct { border-color: #4CAF50; }
    .qo-img-choice.wrong { border-color: #F44336; }

    .qo-img-choice img {
      width: 100%;
      height: 80px;
      object-fit: contain;
    }

    .qo-img-placeholder {
      width: 100%;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #BDBDBD;
    }

    .qo-img-label {
      padding: 6px;
      font-size: 14px;
      font-weight: 700;
      color: #666666;
    }

    .qo-check-btn {
      display: block;
      width: 100%;
      background: #2196F3;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
      margin-bottom: 10px;
    }

    .qo-check-btn:active { opacity: 0.8; }

    .qo-check-btn:disabled {
      background: #E0E0E0;
      color: #BDBDBD;
      cursor: not-allowed;
    }

    .qo-result {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .qo-result.correct {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .qo-result.wrong {
      background: #FFEBEE;
      color: #C62828;
    }

    .qo-explain {
      background: #F9F9F9;
      border: 1px solid #EEEEEE;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 10px;
    }

    .qo-explain-ko {
      font-size: 16px;
      color: #1565C0;
      line-height: 1.6;
      margin-bottom: 6px;
    }

    .qo-explain-ne {
      font-size: 16px;
      color: #2E7D32;
      line-height: 1.6;
    }

    .qo-transcript {
      background: #F3E5F5;
      border: 1px solid #E1BEE7;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 15px;
      color: #7B1FA2;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .qo-retry-one {
      display: block;
      margin: 0 auto 6px;
      background: #F0F0F0;
      border: 1px solid #DDDDDD;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 600;
      color: #555555;
      cursor: pointer;
      font-family: inherit;
    }

    .qo-retry-one:active { opacity: 0.7; }

    .qo-nav {
      flex-shrink: 0;
      display: flex;
      gap: 8px;
      padding: 10px 14px;
      border-top: 1px solid #EEEEEE;
    }

    .qo-nav:empty { display: none; }

    .qo-nav-btn {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .qo-nav-btn:active { opacity: 0.8; }
    .qo-nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .qo-prev {
      background: #E0E0E0;
      color: #333333;
    }

    .qo-next {
      background: #2196F3;
      color: #fff;
    }

    .qo-results-screen {
      text-align: center;
      padding: 24px 14px;
    }

    .qo-results-icon { font-size: 3rem; margin-bottom: 10px; }

    .qo-results-title {
      font-size: 22px;
      font-weight: 900;
      color: #333333;
      margin-bottom: 10px;
    }

    .qo-results-score {
      font-size: 18px;
      color: #2196F3;
      font-weight: 700;
      margin-bottom: 14px;
    }

    .qo-results-detail {
      background: #F9F9F9;
      border: 1px solid #EEEEEE;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 18px;
    }

    .qo-results-row {
      font-size: 16px;
      color: #666666;
      padding: 4px 0;
    }

    .qo-results-btns {
      display: flex;
      gap: 8px;
    }

    .qo-results-btn {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .qo-results-btn:active { opacity: 0.8; }

    .qo-retry {
      background: #2196F3;
      color: #fff;
    }

    .qo-close {
      background: #E0E0E0;
      color: #333333;
    }

    .qo-review-btns {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .qo-review-btn {
      flex: 1;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      font-family: inherit;
    }

    .qo-review-btn:active { opacity: 0.8; }

    .qo-review-btn.ne { background: #4CAF50; }
    .qo-review-btn.ko { background: #2196F3; }

    /* ‚îÄ‚îÄ Quiz Inline Review ‚îÄ‚îÄ */
    .qr-inline-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .qr-inline-title {
      flex: 1;
      font-size: 18px;
      font-weight: 700;
      color: #333333;
    }

    .qr-inline-seek {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .qr-inline-body {
      max-height: 400px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    .quiz-dark .qr-inline-title { color: #fff; }
    .quiz-dark .qo-body .eo-para { color: rgba(255,255,255,0.6); }
    .quiz-dark .qo-body .eo-para.active { color: #fff; background: rgba(255,193,7,0.2); border-left-color: #ffc107; }
    .quiz-dark .qo-body .eo-seek-time { color: rgba(255,255,255,0.5); }
    .quiz-dark .qo-body .eo-seek-input { background: rgba(255,255,255,0.2); }

    /* ‚îÄ‚îÄ Quiz Dark Mode ‚îÄ‚îÄ */
    .quiz-dark { background: #1a1a2e; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    .quiz-dark .qo-header { border-bottom-color: rgba(255,255,255,0.1); }
    .quiz-dark .qo-header-title { color: #fff; }
    .quiz-dark .qo-theme-btn { background: rgba(255,255,255,0.15); }
    .quiz-dark .qo-dot { background: rgba(255,255,255,0.15); }
    .quiz-dark .qo-dot.current { background: #F39C12; box-shadow: 0 0 4px rgba(243,156,18,0.6); }
    .quiz-dark .qo-dot.correct { background: #4caf50; }
    .quiz-dark .qo-dot.wrong { background: #e94560; }
    .quiz-dark .qo-progress { color: #fff; }
    .quiz-dark .qo-progress-section.listening { background: #4caf50; }
    .quiz-dark .qo-instruction { color: #fff; }
    .quiz-dark .qo-image { background: rgba(255,255,255,0.05); }
    .quiz-dark .qo-image-placeholder { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
    .quiz-dark .qo-passage { background: #2a2a4a; border-color: transparent; color: rgba(255,255,255,0.8); }
    .quiz-dark .qo-question { color: rgba(255,255,255,0.85); }
    .quiz-dark .qo-blank { border-bottom-color: #F39C12; color: #F39C12; }
    .quiz-dark .qo-audio-btn { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff; }
    .quiz-dark .qo-audio-btn.playing { background: rgba(76,175,80,0.3); border-color: #4caf50; color: #fff; }
    .quiz-dark .qo-audio-text { color: rgba(255,255,255,0.35); background: rgba(255,255,255,0.05); }
    .quiz-dark .qo-choice { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8); }
    .quiz-dark .qo-choice:active:not(.checked) { background: rgba(255,255,255,0.15); }
    .quiz-dark .qo-choice.selected { border-color: #F39C12; background: rgba(243,156,18,0.15); }
    .quiz-dark .qo-choice.correct { border-color: #4caf50; background: rgba(76,175,80,0.2); color: #fff; }
    .quiz-dark .qo-choice.wrong { border-color: #e94560; background: rgba(233,69,96,0.2); color: #fff; }
    .quiz-dark .qo-img-choice { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.15); }
    .quiz-dark .qo-img-choice.selected { border-color: #F39C12; }
    .quiz-dark .qo-img-choice.correct { border-color: #4caf50; }
    .quiz-dark .qo-img-choice.wrong { border-color: #e94560; }
    .quiz-dark .qo-img-placeholder { color: rgba(255,255,255,0.2); }
    .quiz-dark .qo-img-label { color: rgba(255,255,255,0.6); }
    .quiz-dark .qo-check-btn:disabled { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.3); }
    .quiz-dark .qo-result.correct { background: rgba(76,175,80,0.2); color: #4caf50; }
    .quiz-dark .qo-result.wrong { background: rgba(233,69,96,0.2); color: #e94560; }
    .quiz-dark .qo-explain { background: #2a2a4a; border-color: transparent; }
    .quiz-dark .qo-explain-ko { color: #90caf9; }
    .quiz-dark .qo-explain-ne { color: #a5d6a7; }
    .quiz-dark .qo-transcript { background: rgba(171,71,188,0.15); border-color: transparent; color: #ce93d8; }
    .quiz-dark .qo-retry-one { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.15); color: rgba(255,255,255,0.6); }
    .quiz-dark .qo-nav { border-top-color: rgba(255,255,255,0.1); }
    .quiz-dark .qo-prev { background: rgba(255,255,255,0.15); color: #fff; }
    .quiz-dark .qo-next { background: #F39C12; }
    .quiz-dark .qo-results-title { color: #fff; }
    .quiz-dark .qo-results-score { color: #F39C12; }
    .quiz-dark .qo-results-detail { background: #2a2a4a; border-color: transparent; }
    .quiz-dark .qo-results-row { color: rgba(255,255,255,0.7); }
    .quiz-dark .qo-retry { background: #F39C12; }
    .quiz-dark .qo-close { background: rgba(255,255,255,0.15); color: #fff; }

    /* Close button overrides for quiz overlay */
    .quiz-overlay .eo-btn { background: #F5F5F5; color: #333333; }
    .quiz-overlay .eo-btn:active { background: #E0E0E0; }
    .quiz-dark .eo-btn { background: rgba(255,255,255,0.15); color: #fff; }
    .quiz-dark .eo-btn:active { background: rgba(255,255,255,0.3); }
  </style>
</head>
<body>

<header>
  <div class="logo">K<span class="play">&#9654;</span>Drama TOPIK</div>
</header>

<div class="container">
  <div class="player-wrap" id="player-wrap">
    <div id="player"></div>
    <div class="player-touch-overlay" id="player-touch-overlay"></div>
    <div class="explain-overlay" id="explain-overlay">
      <div class="eo-header">
        <div class="eo-title" id="eo-title"></div>
        <button class="eo-btn" id="eo-play-btn" onclick="toggleModalAudio()">‚ñ∂</button>
        <button class="eo-btn" onclick="closeExplainOverlay()">‚úï</button>
      </div>
      <div class="eo-seekbar">
        <span class="eo-seek-time" id="eo-cur-time">0:00</span>
        <input type="range" class="eo-seek-input" id="eo-seek" min="0" max="100" value="0" step="0.1">
        <span class="eo-seek-time" id="eo-dur-time">0:00</span>
      </div>
      <div class="eo-body" id="eo-body">
        <div id="eo-text"></div>
      </div>
    </div>
  </div>
  <div class="quiz-overlay" id="quiz-overlay">
    <div class="qo-header">
      <div class="qo-header-title">&#128221; EPS-TOPIK</div>
      <button class="qo-theme-btn" id="qo-theme-btn" onclick="toggleQuizTheme()">&#9788;&#65039;</button>
      <button class="eo-btn" onclick="closeQuizOverlay()">&#10005;</button>
    </div>
    <div class="qo-pbar" id="qo-pbar"></div>
    <div class="qo-body" id="qo-body"></div>
    <div class="qo-nav" id="qo-nav"></div>
  </div>

  <div class="tip-banner" id="tip-banner" style="display:none">
    <div class="tip-banner-text">üí° ÏòÅÏÉÅ ÏúÑÏóê 'ÎèôÏòÅÏÉÅ ÎçîÎ≥¥Í∏∞'Í∞Ä Îú®Î©¥ ‚úïÎ•º ÌïúÎ≤à ÎàåÎü¨Ï£ºÏÑ∏Ïöî. Í∞ôÏùÄ Î¨∏Ïû•ÏóêÏÑúÎäî Îã§Ïãú ÎÇòÌÉÄÎÇòÏßÄ ÏïäÏäµÎãàÎã§.</div>
    <button class="tip-banner-close" onclick="closeTipBanner()">‚úï</button>
  </div>

  <div class="now-playing" id="now-playing">
    <div class="now-placeholder" id="now-placeholder">ÏòÅÏÉÅÏùÑ Ïû¨ÏÉùÌïòÎ©¥ ÏûêÎßâÏù¥ ÌëúÏãúÎê©ÎãàÎã§</div>
    <div class="now-ko" id="now-ko"></div>
    <div class="now-ne" id="now-ne"></div>
  </div>

  <div class="loop-bar" id="loop-bar">
    <div class="loop-info" id="loop-info"></div>
    <button class="btn-action btn-repeat" id="btn-repeat" onclick="startLoop()">üîÅ Î∞òÎ≥µ</button>
    <button class="btn-action btn-play-all" id="btn-play-all" onclick="playAll()" style="display:none">‚ñ∂ Ï†ÑÏ≤¥</button>
    <button class="btn-action btn-speed" id="btn-speed" onclick="toggleSpeed()" style="display:none">üê¢1x</button>
    <button class="btn-action btn-stop" id="btn-stop" onclick="stopLoop()" style="display:none">‚èπ Ï§ëÏßÄ</button>
  </div>

  <div class="sub-list-header">
    <h2>ÏûêÎßâ Î™©Î°ù</h2>
    <div class="font-controls">
      <button class="btn-font" onclick="changeFontSize(-1)">A-</button>
      <button class="btn-font" onclick="changeFontSize(1)">A+</button>
    </div>
    <span class="sub-count" id="sub-count"></span>
  </div>

  <div class="sub-list" id="sub-list"></div>
</div>

<script>
var player;
var subtitles = [];
var explanationsMap = {};
var explainAudio = null;
var explainAudioId = null;
var explainAudioLang = null;
var explainParas = [];
var explainHighlightTimer = null;
var explainActivePara = -1;
var eoSeeking = false;
var subtitleTimer = null;
var lastSubId = -1;
var openDetailId = -1;
var currentSub = null;
var loopSub = null;
var loopPausing = false;
var userPaused = false;
var loopPauseTimer = null;
var speedSteps = [1, 0.7, 0.5];
var speedIndex = 0;
var fontScales = [0.85, 1, 1.2, 1.4, 1.7, 2];
var fontLevel = 1; // index into fontScales, default=1 (1x)
var quizData = null;
var quizAllQuestions = [];
var quizIdx = 0;
var quizSelected = -1;
var quizChecked = false;
var quizAnswers = {};
var quizAudioEl = null;


function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function escHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function findSub(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return subtitles[i];
  }
  return null;
}

Promise.all([
  fetch('../data/subtitles.json').then(function(r){return r.json();}),
  fetch('../data/explanations.json').then(function(r){return r.json();}),
  fetch('../data/quiz.json').then(function(r){return r.json();}).catch(function(){return null;})
]).then(function(results) {
  subtitles = results[0];
  explanationsMap = results[1];
  if (results[2]) quizData = results[2]['1'] || null;
  renderList();
});

function changeFontSize(dir) {
  var next = fontLevel + dir;
  if (next < 0 || next >= fontScales.length) return;
  fontLevel = next;
  document.documentElement.style.setProperty('--font-scale', fontScales[fontLevel]);
  // Re-scroll to current page since item heights changed
  if (currentPage !== -1) {
    var pageStart = currentPage * PAGE_SIZE;
    if (pageStart < subtitles.length) {
      var firstEl = document.getElementById('sub-' + subtitles[pageStart].id);
      if (firstEl) {
        var list = document.getElementById('sub-list');
        list.scrollTop = firstEl.offsetTop - list.offsetTop;
      }
    }
  }
}

function renderList() {
  var list = document.getElementById('sub-list');
  document.getElementById('sub-count').textContent = subtitles.length + 'Í∞ú';
  var html = '';
  subtitles.forEach(function(sub) {
    html += '<div class="sub-item" id="sub-' + sub.id + '">' +
      '<div class="sub-row" onclick="onSubClick(' + sub.id + ')">' +
        '<div class="sub-num">' + sub.id + '</div>' +
        '<div class="sub-text">' +
          '<div class="sub-ko">' + escHtml(sub.ko) + '</div>' +
          '<div class="sub-ne">' + escHtml(sub.ne) + '</div>' +
        '</div>' +
        '<div class="loop-badge" id="loop-icon-' + sub.id + '"></div>' +
        '<div class="sub-time">' + formatTime(sub.s) + '</div>' +
      '</div>' +
      '<div class="sub-detail" id="detail-' + sub.id + '">' +
        buildDetail(sub.id) +
      '</div>' +
    '</div>';
  });
  list.innerHTML = html;
}

function buildDetail(id) {
  return buildExplainSection(id);
}

function padId(id) {
  var s = '' + id;
  while (s.length < 3) s = '0' + s;
  return s;
}

function buildExplainSection(id) {
  var hasData = explanationsMap[String(id)];
  var disabled = hasData ? '' : ' disabled';
  var hasQuiz = !!quizData;
  var html = '<div class="explain-section">';
  html += '<div class="explain-btns">';
  html += '<button class="btn-explain btn-explain-ne" onclick="openExplainOverlay(' + id + ',\'ne\')"' + disabled + '>üéß ÎÑ§ÌåîÏñ¥ ÏÑ§Î™Ö</button>';
  html += '<button class="btn-explain btn-explain-kr" onclick="openExplainOverlay(' + id + ',\'kr\')"' + disabled + '>üéß ÌïúÍµ≠Ïñ¥ ÏÑ§Î™Ö</button>';
  html += '</div>';
  if (hasQuiz) {
    html += '<div class="explain-btns" style="margin-top:8px">';
    html += '<button class="btn-explain btn-explain-quiz" onclick="openQuizOverlay()">üìù EPS-TOPIK</button>';
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function renderExplainParas(text) {
  var parts = text.split('\n\n');
  explainParas = parts;
  explainActivePara = -1;
  var container = document.getElementById('eo-text');
  var html = '';
  for (var i = 0; i < parts.length; i++) {
    html += '<div class="eo-para" id="eo-para-' + i + '">' + escHtml(parts[i]) + '</div>';
  }
  container.innerHTML = html;
}

function startExplainHighlight() {
  stopExplainHighlight();
  explainHighlightTimer = setInterval(updateExplainHighlight, 200);
}

function stopExplainHighlight() {
  if (explainHighlightTimer) {
    clearInterval(explainHighlightTimer);
    explainHighlightTimer = null;
  }
}

function fmtAudioTime(sec) {
  if (!sec || isNaN(sec)) return '0:00';
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + (s < 10 ? '0' : '') + s;
}

function getParaIndexAtTime(t, dur) {
  var totalChars = 0;
  for (var i = 0; i < explainParas.length; i++) totalChars += explainParas[i].length;
  if (totalChars === 0) return 0;
  var cumChars = 0;
  for (var i = 0; i < explainParas.length; i++) {
    var paraEnd = ((cumChars + explainParas[i].length) / totalChars) * dur;
    if (t < paraEnd) return i;
    cumChars += explainParas[i].length;
  }
  return explainParas.length - 1;
}

function highlightPara(idx) {
  if (idx === explainActivePara) return;
  if (explainActivePara >= 0) {
    var old = document.getElementById('eo-para-' + explainActivePara);
    if (old) old.classList.remove('active');
  }
  explainActivePara = idx;
  var el = document.getElementById('eo-para-' + idx);
  if (el) {
    el.classList.add('active');
    var body = document.getElementById('eo-body');
    if (body) body.scrollTop = el.offsetTop - body.offsetTop - 10;
  }
}

function updateExplainHighlight() {
  if (!explainAudio || !explainAudio.duration) return;
  var t = explainAudio.currentTime;
  var dur = explainAudio.duration;

  // Update seekbar
  if (!eoSeeking) {
    var seek = document.getElementById('eo-seek');
    seek.max = dur;
    seek.value = t;
  }
  document.getElementById('eo-cur-time').textContent = fmtAudioTime(t);
  document.getElementById('eo-dur-time').textContent = fmtAudioTime(dur);

  // Update paragraph highlight
  if (!explainAudio.paused) {
    highlightPara(getParaIndexAtTime(t, dur));
  }
}

function openExplainOverlay(id, lang) {
  var data = explanationsMap[String(id)];
  if (!data) return;

  // Close quiz if open
  closeQuizOverlay();

  // Pause YouTube
  if (player && player.pauseVideo) player.pauseVideo();

  // Set title
  var title = lang === 'kr' ? 'üéß ÌïúÍµ≠Ïñ¥ ÏÑ§Î™Ö #' + id : 'üéß ÎÑ§ÌåîÏñ¥ ÏÑ§Î™Ö #' + id;
  document.getElementById('eo-title').textContent = title;

  // Show overlay
  document.getElementById('explain-overlay').classList.add('open');

  var playBtn = document.getElementById('eo-play-btn');

  // Same id+lang: resume from where we left off
  if (explainAudio && explainAudioId === id && explainAudioLang === lang) {
    renderExplainParas(data[lang]);
    explainAudio.play();
    playBtn.textContent = '‚è∏';
    playBtn.classList.add('playing');
    startExplainHighlight();
    return;
  }

  // Different id or lang: destroy old, start fresh
  destroyExplainAudio();
  renderExplainParas(data[lang]);
  explainAudioId = id;
  explainAudioLang = lang;
  var path = '../audio/' + lang + '/S01E01_' + padId(id) + '_' + lang + '.mp3';
  explainAudio = new Audio(path);
  playBtn.textContent = '‚è∏';
  playBtn.classList.add('playing');

  explainAudio.onended = function() {
    playBtn.textContent = '‚ñ∂';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  };
  explainAudio.onerror = function() {
    playBtn.textContent = '‚ñ∂';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  };
  explainAudio.play();
  startExplainHighlight();
}

function closeExplainOverlay() {
  document.getElementById('explain-overlay').classList.remove('open');
  stopExplainHighlight();
  // Pause only, keep position
  if (explainAudio && !explainAudio.paused) {
    explainAudio.pause();
  }
  var playBtn = document.getElementById('eo-play-btn');
  playBtn.textContent = '‚ñ∂';
  playBtn.classList.remove('playing');
}

function toggleModalAudio() {
  if (!explainAudio) return;
  var playBtn = document.getElementById('eo-play-btn');
  if (explainAudio.paused) {
    explainAudio.play();
    playBtn.textContent = '‚è∏';
    playBtn.classList.add('playing');
    startExplainHighlight();
  } else {
    explainAudio.pause();
    playBtn.textContent = '‚ñ∂';
    playBtn.classList.remove('playing');
    stopExplainHighlight();
  }
}

function destroyExplainAudio() {
  stopExplainHighlight();
  if (explainAudio) {
    explainAudio.pause();
    explainAudio = null;
  }
  explainAudioId = null;
  explainAudioLang = null;
  explainParas = [];
  explainActivePara = -1;
}

/* ‚îÄ‚îÄ Quiz Overlay ‚îÄ‚îÄ */
function buildQuizAllQuestions() {
  if (!quizData) return [];
  var r = quizData.reading || [];
  var l = quizData.listening || [];
  return r.concat(l);
}

function getQuizSection(q) {
  if (!quizData) return 'reading';
  var rIds = {};
  var r = quizData.reading || [];
  for (var i = 0; i < r.length; i++) rIds[r[i].id] = true;
  return rIds[q.id] ? 'reading' : 'listening';
}

function applyQuizTheme() {
  var overlay = document.getElementById('quiz-overlay');
  var btn = document.getElementById('qo-theme-btn');
  var saved = localStorage.getItem('quizTheme') || 'light';
  if (saved === 'dark') {
    overlay.classList.add('quiz-dark');
    btn.innerHTML = '&#9728;&#65039;';
  } else {
    overlay.classList.remove('quiz-dark');
    btn.innerHTML = '&#127769;';
  }
}

function toggleQuizTheme() {
  var current = localStorage.getItem('quizTheme') || 'light';
  var next = current === 'light' ? 'dark' : 'light';
  localStorage.setItem('quizTheme', next);
  applyQuizTheme();
}

function openQuizOverlay() {
  closeExplainOverlay();
  if (player && player.pauseVideo) player.pauseVideo();

  quizAllQuestions = buildQuizAllQuestions();
  quizIdx = 0;
  quizSelected = -1;
  quizChecked = false;
  quizAnswers = {};

  document.getElementById('player-wrap').style.display = 'none';
  document.getElementById('quiz-overlay').classList.add('open');
  applyQuizTheme();
  renderQuiz();
  scrollQuizToTop();
}

function closeQuizOverlay() {
  if (qrOpen) { destroyQrAudio(); qrOpen = false; }
  document.getElementById('quiz-overlay').classList.remove('open');
  document.getElementById('player-wrap').style.display = '';
  stopQuizAudio();
}

function renderQuiz() {
  var qs = quizAllQuestions;
  var total = qs.length;

  if (total === 0) {
    document.getElementById('qo-pbar').innerHTML = '';
    document.getElementById('qo-body').innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    document.getElementById('qo-nav').innerHTML = '';
    return;
  }

  var q = qs[quizIdx];
  var answered = quizAnswers[q.id];
  if (answered) {
    quizSelected = answered.selected;
    quizChecked = true;
  }

  renderQuizProgressBar(quizIdx, total);
  renderQuizQuestion(q, quizIdx, total);
  renderQuizNav(quizIdx, total);
}

function renderQuizProgressBar(idx, total) {
  var pbar = document.getElementById('qo-pbar');
  var html = '';
  for (var i = 0; i < total; i++) {
    var cls = 'qo-dot';
    var a = quizAnswers[quizAllQuestions[i].id];
    if (a) {
      cls += a.correct ? ' correct' : ' wrong';
    }
    if (i === idx) cls += ' current';
    html += '<div class="' + cls + '" onclick="jumpToQuiz(' + i + ')"></div>';
  }
  pbar.innerHTML = html;
}

function renderQuizQuestion(q, idx, total) {
  stopQuizAudio();
  var body = document.getElementById('qo-body');
  var html = '';
  var nums = ['‚ë†', '‚ë°', '‚ë¢', '‚ë£'];
  var sec = getQuizSection(q);

  // Progress with section label
  html += '<div class="qo-progress">';
  if (sec === 'reading') {
    html += '<span class="qo-progress-section reading">üìñ ÏùΩÍ∏∞</span>';
  } else {
    html += '<span class="qo-progress-section listening">üéß Îì£Í∏∞</span>';
  }
  html += 'Î¨∏Ï†ú ' + (idx + 1) + '/' + total;
  html += '</div>';

  // Instruction
  html += '<div class="qo-instruction">' + escHtml(q.instruction) + '</div>';

  // Audio button (listening)
  if (q.audio) {
    html += '<div class="qo-audio-wrap">';
    html += '<button class="qo-audio-btn" id="qo-audio-btn" onclick="toggleQuizAudio()">üîä ÏùåÏÑ± Îì£Í∏∞</button>';
    if (q.audio_text) {
      html += '<div class="qo-audio-text">' + escHtml(q.audio_text).replace(/\n/g, '<br>') + '</div>';
    }
    html += '</div>';
  }

  // Image
  if (q.image && !q.image_choices) {
    html += '<div class="qo-image-wrap">';
    html += '<img class="qo-image" src="../' + escHtml(q.image) + '" onload="this.style.display=\'\';this.nextElementSibling.style.display=\'none\'" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'" style="display:none">';
    html += '<div class="qo-image-placeholder">üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ Ï§ë</div>';
    html += '</div>';
  }

  // Passage
  if (q.passage) {
    html += '<div class="qo-passage">' + escHtml(q.passage) + '</div>';
  }

  // Question text (fill-blank / vocab / story question)
  if (q.question) {
    var qText = escHtml(q.question).replace(/\n/g, '<br>').replace(/\(          \)/g, '<span class="qo-blank">______</span>');
    html += '<div class="qo-question">' + qText + '</div>';
  }

  var isCorrect = quizChecked && quizSelected === q.answer;

  // Image choices (2x2 grid)
  if (q.image_choices) {
    html += '<div class="qo-img-choices">';
    for (var ic = 0; ic < q.image_choices.length; ic++) {
      var icCls = 'qo-img-choice';
      if (quizChecked && isCorrect && ic === q.answer) icCls += ' correct';
      else if (quizChecked && !isCorrect && ic === quizSelected) icCls += ' wrong';
      else if (!quizChecked && ic === quizSelected) icCls += ' selected';
      if (quizChecked && ic !== quizSelected) icCls += ' dimmed';

      html += '<div class="' + icCls + '" onclick="selectQuizChoice(' + ic + ')">';
      html += '<img src="../' + escHtml(q.image_choices[ic]) + '" onload="this.style.display=\'\';this.nextElementSibling.style.display=\'none\'" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'" style="display:none">';
      html += '<div class="qo-img-placeholder">üñºÔ∏è</div>';
      html += '<div class="qo-img-label">' + nums[ic] + ' ' + escHtml(q.choices_desc[ic]) + '</div>';
      html += '</div>';
    }
    html += '</div>';
  } else {
    // Text choices
    html += '<div class="qo-choices">';
    for (var i = 0; i < q.choices.length; i++) {
      var cls = 'qo-choice';
      if (quizChecked && isCorrect && i === q.answer) cls += ' correct checked';
      else if (quizChecked && !isCorrect && i === quizSelected) cls += ' wrong checked';
      else if (!quizChecked && i === quizSelected) cls += ' selected';
      if (quizChecked && i !== quizSelected) cls += ' dimmed checked';

      html += '<button class="' + cls + '" onclick="selectQuizChoice(' + i + ')">';
      html += '<span class="qo-choice-num">' + nums[i] + '</span>';
      html += '<span class="qo-choice-text">' + escHtml(q.choices[i]) + '</span>';
      html += '</button>';
    }
    html += '</div>';
  }

  // Check button (before answer)
  if (!quizChecked) {
    html += '<button class="qo-check-btn" id="qo-check" onclick="checkQuizAnswer()"' + (quizSelected === -1 ? ' disabled' : '') + '>Ï†ïÎãµ ÌôïÏù∏</button>';
  }

  // Result + Explanation (after checking)
  if (quizChecked) {
    html += '<div class="qo-result ' + (isCorrect ? 'correct' : 'wrong') + '">';
    html += isCorrect ? '‚≠ï Ï†ïÎãµ!' : '‚ùå Ïò§Îãµ!';
    html += '</div>';

    if (isCorrect) {
      html += '<div class="qo-explain">';
      html += '<div class="qo-explain-ko">üí° ' + escHtml(q.explanation_ko) + '</div>';
      html += '<div class="qo-explain-ne">üá≥üáµ ' + escHtml(q.explanation_ne) + '</div>';
      html += '</div>';

      if (q.audio_text) {
        html += '<div class="qo-transcript">üîà ' + escHtml(q.audio_text).replace(/\n/g, '<br>') + '</div>';
      }

      var rev = quizData && quizData.review && quizData.review[q.id];
      if (rev) {
        html += '<div class="qo-review-btns">';
        html += '<button class="qo-review-btn ne" onclick="openReviewExplain(\'' + q.id + '\',\'ne\')">üá≥üáµ ÎÑ§ÌåîÏñ¥ Î¨∏Ï†úÏÑ§Î™Ö</button>';
        html += '<button class="qo-review-btn ko" onclick="openReviewExplain(\'' + q.id + '\',\'ko\')">üá∞üá∑ ÌïúÍµ≠Ïñ¥ Î¨∏Ï†úÏÑ§Î™Ö</button>';
        html += '</div>';
      }
    } else {
      html += '<button class="qo-retry-one" onclick="retryCurrentQuiz()">&#128260; Îã§Ïãú ÌíÄÍ∏∞</button>';
    }
  }

  body.innerHTML = html;
}

function scrollQuizToTop() {
  var el = document.getElementById('quiz-overlay');
  if (el) el.scrollIntoView({ behavior: 'auto', block: 'start' });
}

function renderQuizNav(idx, total) {
  var nav = document.getElementById('qo-nav');
  var html = '';

  if (idx > 0) {
    html += '<button class="qo-nav-btn qo-prev" onclick="quizPrev()">‚Üê Ïù¥Ï†Ñ</button>';
  }

  if (idx < total - 1) {
    html += '<button class="qo-nav-btn qo-next" onclick="quizNext()">Îã§Ïùå ‚Üí</button>';
  } else {
    var allDone = true;
    for (var i = 0; i < quizAllQuestions.length; i++) {
      if (!quizAnswers[quizAllQuestions[i].id]) { allDone = false; break; }
    }
    html += '<button class="qo-nav-btn qo-next" onclick="showQuizResults()"' + (allDone ? '' : ' disabled') + '>Í≤∞Í≥º Î≥¥Í∏∞</button>';
  }

  nav.innerHTML = html;
}

function jumpToQuiz(idx) {
  if (qrOpen) { destroyQrAudio(); qrOpen = false; }
  quizIdx = idx;
  var q = quizAllQuestions[quizIdx];
  var answered = quizAnswers[q.id];
  if (answered) {
    quizSelected = answered.selected;
    quizChecked = true;
  } else {
    quizSelected = -1;
    quizChecked = false;
  }
  renderQuiz();
  scrollQuizToTop();
}

function selectQuizChoice(idx) {
  if (quizChecked) return;
  quizSelected = idx;
  renderQuiz();
}

function playQuizSound(correct) {
  try {
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (correct) {
      // ÎùµÎèô: C5 ‚Üí E5
      [523, 659].forEach(function(freq, i) {
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(1.0, ctx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.3);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(ctx.currentTime + i * 0.15);
        osc.stop(ctx.currentTime + i * 0.15 + 0.3);
      });
    } else {
      // ÎöúÎöú: low tones
      [200, 180].forEach(function(freq, i) {
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(1.0, ctx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.2);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(ctx.currentTime + i * 0.15);
        osc.stop(ctx.currentTime + i * 0.15 + 0.2);
      });
    }
  } catch(e) {}
}

function checkQuizAnswer() {
  if (quizSelected === -1) return;
  var q = quizAllQuestions[quizIdx];
  quizChecked = true;
  var isCorrect = quizSelected === q.answer;
  quizAnswers[q.id] = { selected: quizSelected, correct: isCorrect };
  playQuizSound(isCorrect);
  renderQuiz();
}

function quizPrev() {
  if (quizIdx > 0) {
    quizIdx--;
    var q = quizAllQuestions[quizIdx];
    var answered = quizAnswers[q.id];
    if (answered) {
      quizSelected = answered.selected;
      quizChecked = true;
    } else {
      quizSelected = -1;
      quizChecked = false;
    }
    renderQuiz();
    scrollQuizToTop();
  }
}

function quizNext() {
  if (quizIdx < quizAllQuestions.length - 1) {
    quizIdx++;
    var q = quizAllQuestions[quizIdx];
    var answered = quizAnswers[q.id];
    if (answered) {
      quizSelected = answered.selected;
      quizChecked = true;
    } else {
      quizSelected = -1;
      quizChecked = false;
    }
    renderQuiz();
    scrollQuizToTop();
  }
}

function showQuizResults() {
  stopQuizAudio();
  var body = document.getElementById('qo-body');
  var nav = document.getElementById('qo-nav');
  var pbar = document.getElementById('qo-pbar');

  var rQs = quizData.reading || [];
  var lQs = quizData.listening || [];
  var rCorrect = 0, lCorrect = 0;

  for (var i = 0; i < rQs.length; i++) {
    if (quizAnswers[rQs[i].id] && quizAnswers[rQs[i].id].correct) rCorrect++;
  }
  for (var i = 0; i < lQs.length; i++) {
    if (quizAnswers[lQs[i].id] && quizAnswers[lQs[i].id].correct) lCorrect++;
  }

  var total = quizAllQuestions.length;
  var correct = rCorrect + lCorrect;
  var pct = total > 0 ? Math.round(correct / total * 100) : 0;

  var html = '<div class="qo-results-screen">';
  html += '<div class="qo-results-icon">üéâ</div>';
  html += '<div class="qo-results-title">ÌÄ¥Ï¶à ÏôÑÎ£å!</div>';
  html += '<div class="qo-results-score">' + correct + '/' + total + ' Î¨∏Ï†ú Ï†ïÎãµ (' + pct + '%)</div>';
  html += '<div class="qo-results-detail">';
  html += '<div class="qo-results-row">üìñ ÏùΩÍ∏∞: ' + rCorrect + '/' + rQs.length + '</div>';
  html += '<div class="qo-results-row">üéß Îì£Í∏∞: ' + lCorrect + '/' + lQs.length + '</div>';
  html += '</div>';
  html += '<div class="qo-results-btns">';
  html += '<button class="qo-results-btn qo-retry" onclick="retryQuiz()">üîÑ Îã§Ïãú ÌíÄÍ∏∞</button>';
  html += '<button class="qo-results-btn qo-close" onclick="closeQuizOverlay()">‚úï Îã´Í∏∞</button>';
  html += '</div>';
  html += '</div>';

  body.innerHTML = html;
  body.scrollTop = 0;
  nav.innerHTML = '';
  pbar.innerHTML = '';
}

function retryCurrentQuiz() {
  var q = quizAllQuestions[quizIdx];
  if (q) delete quizAnswers[q.id];
  quizSelected = -1;
  quizChecked = false;
  renderQuiz();
}

function retryQuiz() {
  quizIdx = 0;
  quizSelected = -1;
  quizChecked = false;
  quizAnswers = {};
  quizAllQuestions = buildQuizAllQuestions();
  renderQuiz();
  scrollQuizToTop();
}

/* ‚îÄ‚îÄ Quiz Review (renders inside qo-body) ‚îÄ‚îÄ */
var qrAudio = null;
var qrParas = [];
var qrActivePara = -1;
var qrTimer = null;
var qrOpen = false;
var qrSavedBody = '';
var qrSavedNav = '';

function openReviewExplain(qId, lang) {
  var rev = quizData && quizData.review && quizData.review[qId];
  if (!rev) return;

  var text = lang === 'ko' ? rev.ko_text : rev.ne_text;
  var audioSrc = lang === 'ko' ? rev.ko_audio : rev.ne_audio;
  var title = lang === 'ko' ? 'üá∞üá∑ ÌïúÍµ≠Ïñ¥ Î¨∏Ï†úÏÑ§Î™Ö' : 'üá≥üáµ ÎÑ§ÌåîÏñ¥ Î¨∏Ï†úÏÑ§Î™Ö';

  stopQuizAudio();
  if (qrOpen) destroyQrAudio();

  var body = document.getElementById('qo-body');
  var nav = document.getElementById('qo-nav');

  // Save current quiz content before overwriting
  if (!qrOpen) {
    qrSavedBody = body.innerHTML;
    qrSavedNav = nav.innerHTML;
  }
  qrOpen = true;

  var parts = text ? text.split('\n\n') : [];
  qrParas = parts;
  qrActivePara = -1;

  var html = '';
  html += '<div class="qr-inline-header">';
  html += '<div class="qr-inline-title">' + escHtml(title) + '</div>';
  html += '<button class="eo-btn" id="qr-play" onclick="toggleQrAudio()">&#9654;</button>';
  html += '<button class="eo-btn" onclick="closeReviewExplain()">&#10005;</button>';
  html += '</div>';
  html += '<div class="qr-inline-seek">';
  html += '<span class="eo-seek-time" id="qr-cur">0:00</span>';
  html += '<input type="range" class="eo-seek-input" id="qr-seek" min="0" max="100" value="0" step="0.1">';
  html += '<span class="eo-seek-time" id="qr-dur">0:00</span>';
  html += '</div>';
  html += '<div class="qr-inline-body">';
  for (var i = 0; i < parts.length; i++) {
    html += '<div class="eo-para" id="qr-p-' + i + '">' + escHtml(parts[i]) + '</div>';
  }
  html += '</div>';

  body.innerHTML = html;
  nav.innerHTML = '<button class="qo-nav-btn qo-prev" onclick="closeReviewExplain()">‚Üê Î¨∏Ï†úÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>';

  // Bind seekbar
  var seek = document.getElementById('qr-seek');
  seek.addEventListener('input', function() {
    if (qrAudio && qrAudio.duration) {
      document.getElementById('qr-cur').textContent = fmtAudioTime(Number(seek.value));
      qrHighlight(getQrParaAt(Number(seek.value), qrAudio.duration));
    }
  });
  seek.addEventListener('change', function() {
    if (qrAudio && qrAudio.duration) {
      qrAudio.currentTime = Number(seek.value);
    }
  });

  // Start audio
  var playBtn = document.getElementById('qr-play');
  if (audioSrc) {
    qrAudio = new Audio('../' + audioSrc);
    playBtn.textContent = '‚è∏';
    playBtn.classList.add('playing');
    qrAudio.onended = function() {
      playBtn.textContent = '‚ñ∂';
      playBtn.classList.remove('playing');
      stopQrTimer();
    };
    qrAudio.onerror = function() {
      playBtn.textContent = '‚ñ∂';
      playBtn.classList.remove('playing');
      stopQrTimer();
    };
    qrAudio.play();
    startQrTimer();
  }

  scrollQuizToTop();
}

function closeReviewExplain() {
  if (!qrOpen) return;
  destroyQrAudio();
  qrOpen = false;

  // Restore saved quiz content
  document.getElementById('qo-body').innerHTML = qrSavedBody;
  document.getElementById('qo-nav').innerHTML = qrSavedNav;
  qrSavedBody = '';
  qrSavedNav = '';
}

function destroyQrAudio() {
  stopQrTimer();
  if (qrAudio) { qrAudio.pause(); qrAudio = null; }
  qrParas = [];
  qrActivePara = -1;
}

function toggleQrAudio() {
  if (!qrAudio) return;
  var btn = document.getElementById('qr-play');
  if (qrAudio.paused) {
    qrAudio.play();
    btn.textContent = '‚è∏';
    btn.classList.add('playing');
    startQrTimer();
  } else {
    qrAudio.pause();
    btn.textContent = '‚ñ∂';
    btn.classList.remove('playing');
    stopQrTimer();
  }
}

function startQrTimer() {
  stopQrTimer();
  qrTimer = setInterval(updateQrHighlight, 200);
}

function stopQrTimer() {
  if (qrTimer) { clearInterval(qrTimer); qrTimer = null; }
}

function qrHighlight(idx) {
  if (idx === qrActivePara) return;
  if (qrActivePara >= 0) {
    var old = document.getElementById('qr-p-' + qrActivePara);
    if (old) old.classList.remove('active');
  }
  qrActivePara = idx;
  var el = document.getElementById('qr-p-' + idx);
  if (el) {
    el.classList.add('active');
    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function getQrParaAt(t, dur) {
  var total = 0;
  for (var i = 0; i < qrParas.length; i++) total += qrParas[i].length;
  if (total === 0) return 0;
  var cum = 0;
  for (var i = 0; i < qrParas.length; i++) {
    if (t < ((cum + qrParas[i].length) / total) * dur) return i;
    cum += qrParas[i].length;
  }
  return qrParas.length - 1;
}

function updateQrHighlight() {
  if (!qrAudio || !qrAudio.duration) return;
  var t = qrAudio.currentTime;
  var dur = qrAudio.duration;
  var seek = document.getElementById('qr-seek');
  if (seek) { seek.max = dur; seek.value = t; }
  var cur = document.getElementById('qr-cur');
  var durEl = document.getElementById('qr-dur');
  if (cur) cur.textContent = fmtAudioTime(t);
  if (durEl) durEl.textContent = fmtAudioTime(dur);
  if (!qrAudio.paused) qrHighlight(getQrParaAt(t, dur));
}

function toggleQuizAudio() {
  var q = quizAllQuestions[quizIdx];
  if (!q || !q.audio) return;

  var btn = document.getElementById('qo-audio-btn');

  if (quizAudioEl && !quizAudioEl.paused) {
    quizAudioEl.pause();
    quizAudioEl.currentTime = 0;
    if (btn) btn.classList.remove('playing');
    return;
  }

  stopQuizAudio();
  quizAudioEl = new Audio('../' + q.audio);
  if (btn) btn.classList.add('playing');

  quizAudioEl.onended = function() {
    if (btn) btn.classList.remove('playing');
  };
  quizAudioEl.onerror = function() {
    if (btn) {
      btn.classList.remove('playing');
      btn.textContent = 'üîä ÏùåÏÑ± ÌååÏùº Ï§ÄÎπÑ Ï§ë';
    }
  };
  quizAudioEl.play().catch(function() {
    if (btn) {
      btn.classList.remove('playing');
      btn.textContent = 'üîä ÏùåÏÑ± ÌååÏùº Ï§ÄÎπÑ Ï§ë';
    }
  });
}

function stopQuizAudio() {
  if (quizAudioEl) {
    quizAudioEl.pause();
    quizAudioEl = null;
  }
}

/* ‚îÄ‚îÄ Subtitle Click ‚îÄ‚îÄ */
var clickLock = false;

function onSubClick(id) {
  if (clickLock) return;
  clickLock = true;
  setTimeout(function(){ clickLock = false; }, 300);

  var sub = findSub(id);
  if (!sub) return;

  // Close previous detail (different subtitle)
  if (openDetailId !== -1 && openDetailId !== id) {
    closeDetail(openDetailId);
  }

  // Close explain overlay (pauses audio, keeps position)
  closeExplainOverlay();

  // Cancel any existing loop
  cancelLoop();

  // Set current subtitle for play-once
  userPaused = false;
  currentSub = sub;
  openDetailId = id;

  // Seek + play (single play)
  if (player && player.seekTo) {
    player.seekTo(sub.s, true);
    player.playVideo();
  }
  showTouchOverlay(true);

  // Open detail
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.add('open');

  // Scroll to page group
  scrollToPage(id);

  // Show bar with repeat button
  showBar('once');

  updateNowPlaying(id);
}

function startLoop() {
  if (!currentSub) return;

  // Close explain overlay first (pause audio, keep position)
  closeExplainOverlay();

  userPaused = false;
  loopSub = currentSub;
  loopPausing = false;

  // Seek to start and play
  if (player && player.seekTo) {
    player.seekTo(loopSub.s, true);
    player.playVideo();
  }

  // Loop visual on subtitle item
  var icon = document.getElementById('loop-icon-' + loopSub.id);
  if (icon) icon.textContent = 'üîÅ';
  var item = document.getElementById('sub-' + loopSub.id);
  if (item) item.classList.add('looping');

  showBar('loop');
}

function toggleSpeed() {
  speedIndex = (speedIndex + 1) % speedSteps.length;
  var rate = speedSteps[speedIndex];
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(rate);
  }
  document.getElementById('btn-speed').textContent = 'üê¢' + rate + 'x';
}

function resetSpeed() {
  speedIndex = 0;
  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(1);
  }
  document.getElementById('btn-speed').textContent = 'üê¢1x';
}

function stopLoop() {
  cancelLoop();
  resetSpeed();
  // Pause at current position
  if (player && player.pauseVideo) player.pauseVideo();
  // Stay on current subtitle with once-mode bar
  if (currentSub) {
    showBar('once');
    showTouchOverlay(true);
  }
}

function cancelLoop() {
  if (loopPauseTimer) {
    clearTimeout(loopPauseTimer);
    loopPauseTimer = null;
  }
  loopPausing = false;

  if (loopSub) {
    var icon = document.getElementById('loop-icon-' + loopSub.id);
    if (icon) icon.textContent = '';
    var item = document.getElementById('sub-' + loopSub.id);
    if (item) item.classList.remove('looping');
    loopSub = null;
  }
}

function resetAllState() {
  closeExplainOverlay();
  closeQuizOverlay();
  cancelLoop();
  resetSpeed();
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }
  currentSub = null;
  loopPausing = false;
  userPaused = false;
  document.getElementById('loop-bar').classList.remove('active');
  showTouchOverlay(false);
}

function playAll() {
  resetAllState();
  // Play from current position
  if (player && player.playVideo) player.playVideo();
}

function showBar(mode) {
  var bar = document.getElementById('loop-bar');
  var info = document.getElementById('loop-info');
  var btnRepeat = document.getElementById('btn-repeat');
  var btnPlayAll = document.getElementById('btn-play-all');
  var btnSpeed = document.getElementById('btn-speed');
  var btnStop = document.getElementById('btn-stop');
  var sub = currentSub;
  if (!sub) return;

  bar.classList.add('active');
  var label = '#' + sub.id + ' ' + escHtml(sub.ko.substring(0, 25)) + (sub.ko.length > 25 ? '...' : '');

  if (mode === 'once') {
    info.innerHTML = '<strong>‚ñ∂ Ïû¨ÏÉù Ï§ë</strong> ' + label;
    btnRepeat.style.display = '';
    btnPlayAll.style.display = '';
    btnSpeed.style.display = 'none';
    btnStop.style.display = 'none';
  } else {
    info.innerHTML = '<strong>üîÅ Î∞òÎ≥µ Ïû¨ÏÉù Ï§ë</strong> ' + label;
    btnRepeat.style.display = 'none';
    btnPlayAll.style.display = 'none';
    btnSpeed.style.display = '';
    btnStop.style.display = '';
  }
}

function closeDetail(id) {
  var el = document.getElementById('detail-' + id);
  if (el) el.classList.remove('open');
}

function closeAllDetails() {
  if (openDetailId !== -1) {
    closeDetail(openDetailId);
    openDetailId = -1;
  }
}

function updateNowPlaying(id) {
  var sub = findSub(id);
  if (!sub) return;
  document.getElementById('now-ko').textContent = sub.ko;
  document.getElementById('now-ne').textContent = sub.ne;
  document.getElementById('now-placeholder').style.display = 'none';
}

/* ‚îÄ‚îÄ YouTube ‚îÄ‚îÄ */
var tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: 'srN85EUD1kI',
    playerVars: { rel: 0, modestbranding: 1, playsinline: 1 },
    events: {
      onStateChange: onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    startSubtitleSync();
    showTouchOverlay(true);
  } else if (event.data === YT.PlayerState.PAUSED) {
    stopSubtitleSync();
    showTouchOverlay(true);
  }
}

function showTouchOverlay(show) {
  // Disabled: transparent overlay was blocking YouTube UI (‚úï button on ÎèôÏòÅÏÉÅ ÎçîÎ≥¥Í∏∞)
  // Play/pause via spacebar and subtitle clicks still work without it
}

function startSubtitleSync() {
  stopSubtitleSync();
  subtitleTimer = setInterval(updateSubtitle, 200);
}

function stopSubtitleSync() {
  if (subtitleTimer) {
    clearInterval(subtitleTimer);
    subtitleTimer = null;
  }
}

function updateSubtitle() {
  if (userPaused) return;
  var t = player.getCurrentTime();

  // Detail open: stay within current segment, loop back to start
  if (currentSub && !loopSub && t >= currentSub.e) {
    player.seekTo(currentSub.s, true);
    return;
  }

  // Loop: seek to start immediately, then pause 0.7s before playing
  if (loopSub && !loopPausing && t >= loopSub.e) {
    loopPausing = true;
    player.seekTo(loopSub.s, true);
    player.pauseVideo();
    loopPauseTimer = setTimeout(function() {
      if (loopSub && !userPaused) {
        player.playVideo();
        loopPausing = false;
      }
    }, 700);
    return;
  }

  var found = null;
  for (var i = 0; i < subtitles.length; i++) {
    if (t >= subtitles[i].s && t < subtitles[i].e) {
      found = subtitles[i];
      break;
    }
  }

  if (found && found.id !== lastSubId) {
    lastSubId = found.id;
    updateNowPlaying(found.id);
    highlightSub(found.id);
  } else if (!found && lastSubId !== -1) {
    lastSubId = -1;
    document.getElementById('now-ko').textContent = '';
    document.getElementById('now-ne').textContent = '';
    clearHighlight();
  }
}

var PAGE_SIZE = 4;
var currentPage = -1;

function getPage(id) {
  for (var i = 0; i < subtitles.length; i++) {
    if (subtitles[i].id === id) return Math.floor(i / PAGE_SIZE);
  }
  return -1;
}

function scrollToPage(id) {
  var page = getPage(id);
  if (page === -1 || page === currentPage) return;
  currentPage = page;
  var pageStart = page * PAGE_SIZE;
  var firstEl = document.getElementById('sub-' + subtitles[pageStart].id);
  if (firstEl) {
    var list = document.getElementById('sub-list');
    list.scrollTop = firstEl.offsetTop - list.offsetTop;
  }
}

var activeEl = null;

function highlightSub(id) {
  if (activeEl) activeEl.classList.remove('active');
  var el = document.getElementById('sub-' + id);
  if (el) {
    el.classList.add('active');
    activeEl = el;
    if (!loopSub) {
      scrollToPage(id);
    }
  }
}

function clearHighlight() {
  if (activeEl) {
    activeEl.classList.remove('active');
    activeEl = null;
  }
}

/* ‚îÄ‚îÄ Seekbar events ‚îÄ‚îÄ */
(function() {
  var seek = document.getElementById('eo-seek');
  seek.addEventListener('input', function() {
    eoSeeking = true;
    if (explainAudio && explainAudio.duration) {
      document.getElementById('eo-cur-time').textContent = fmtAudioTime(Number(seek.value));
      highlightPara(getParaIndexAtTime(Number(seek.value), explainAudio.duration));
    }
  });
  seek.addEventListener('change', function() {
    if (explainAudio && explainAudio.duration) {
      explainAudio.currentTime = Number(seek.value);
    }
    eoSeeking = false;
  });
})();

/* ‚îÄ‚îÄ User play/pause toggle ‚îÄ‚îÄ */
function userTogglePlay() {
  if (!player || !player.getPlayerState) return;
  var state = player.getPlayerState();
  if (state === YT.PlayerState.PLAYING) {
    userPaused = true;
    player.pauseVideo();
  } else {
    userPaused = false;
    player.playVideo();
  }
}

/* ‚îÄ‚îÄ Player touch overlay click ‚îÄ‚îÄ */
document.getElementById('player-touch-overlay').addEventListener('click', function() {
  userTogglePlay();
});

/* ‚îÄ‚îÄ Blur YouTube iframe to prevent spacebar conflict ‚îÄ‚îÄ */
window.addEventListener('blur', function() {
  setTimeout(function() {
    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
      document.activeElement.blur();
    }
  }, 0);
});

/* ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ */
document.addEventListener('keydown', function(e) {
  if (e.code !== 'Space') return;
  var tag = e.target.tagName;
  if (tag === 'INPUT' || tag === 'BUTTON' || tag === 'TEXTAREA') return;
  e.preventDefault();
  userTogglePlay();
});

/* ‚îÄ‚îÄ Tip banner ‚îÄ‚îÄ */
if (!localStorage.getItem('tipBannerDismissed')) {
  document.getElementById('tip-banner').style.display = 'flex';
}
function closeTipBanner() {
  document.getElementById('tip-banner').style.display = 'none';
  localStorage.setItem('tipBannerDismissed', '1');
}

/* ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
